#!/bin/bash
# mattfuncional - Men√∫ de gesti√≥n (ejecutar desde la ra√≠z del proyecto: ./mattfuncional)
# Servidor: Donweb - 149.50.144.53 | Puerto: 8080

# Directorio del proyecto = donde est√° este script (ra√≠z del repo)
APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
JAR_NAME="mattfuncional-0.0.1-SNAPSHOT.jar"
JAR_PATH="$APP_DIR/target/$JAR_NAME"
LOG_FILE="$APP_DIR/logs/mattfuncional.log"
PID_FILE="$APP_DIR/mattfuncional.pid"
APP_PORT="${MATT_APP_PORT:-8080}"
SPRING_PROFILE="donweb"
JAVA_DB_OPTS=""
[ -n "$MATT_DB_USER" ] && JAVA_DB_OPTS="$JAVA_DB_OPTS -Dspring.datasource.username=$MATT_DB_USER"
[ -n "$MATT_DB_PASSWORD" ] && JAVA_DB_OPTS="$JAVA_DB_OPTS -Dspring.datasource.password=$MATT_DB_PASSWORD"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_header() {
    echo -e "${CYAN}=========================================="
    echo -e "   MATTFUNCIONAL - MEN√ö DE GESTI√ìN"
    echo -e "==========================================${NC}"
}

print_option() { echo -e "${BLUE}$1${NC}"; }
print_success() { echo -e "${GREEN}‚úÖ $1${NC}"; }
print_warning() { echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"; }
print_error() { echo -e "${RED}‚ùå $1${NC}"; }

get_pid() {
    if [ -f "$PID_FILE" ]; then cat "$PID_FILE"
    else pgrep -f "mattfuncional.*$JAR_NAME" 2>/dev/null || echo ""
    fi
}

check_app_status() {
    if pgrep -f "mattfuncional.*$JAR_NAME" > /dev/null; then
        PID=$(get_pid); [ -z "$PID" ] && PID=$(pgrep -f "mattfuncional.*$JAR_NAME")
        echo -e "${GREEN}‚óÜ Mattfuncional corriendo (PID: $PID) - Puerto $APP_PORT${NC}"
        return 0
    else
        echo -e "${RED}‚óÜ Mattfuncional no est√° corriendo${NC}"
        return 1
    fi
}

stop_app() {
    print_option "1Ô∏è‚É£ Parando aplicaci√≥n Mattfuncional..."
    if pgrep -f "mattfuncional.*$JAR_NAME" > /dev/null; then
        pkill -f "mattfuncional.*$JAR_NAME"
        sleep 3
        if pgrep -f "mattfuncional.*$JAR_NAME" > /dev/null; then
            print_warning "Forzando cierre..."
            pkill -9 -f "mattfuncional.*$JAR_NAME"
        fi
        rm -f "$PID_FILE"
        print_success "Aplicaci√≥n Mattfuncional detenida"
    else
        print_warning "No hay aplicaci√≥n Mattfuncional corriendo"
    fi
}

update_code() {
    print_option "2Ô∏è‚É£ Actualizando c√≥digo desde GitHub..."
    cd "$APP_DIR" || { print_error "Error: No se pudo cambiar al directorio del proyecto"; return 1; }
    if ! git diff --quiet 2>/dev/null || ! git diff --cached --quiet 2>/dev/null; then
        print_warning "Hay cambios locales sin commitear. Guardando cambios..."
        git stash push -m "Cambios locales antes de pull - $(date +%Y-%m-%d_%H:%M:%S)"
        print_success "Cambios locales guardados en stash"
    fi
    git fetch origin
    if git rev-parse --verify origin/main > /dev/null 2>&1; then
        if git pull origin main; then
            print_success "C√≥digo actualizado desde main"
            if git stash list | grep -q "Cambios locales antes de pull"; then
                print_warning "Intentando aplicar cambios locales guardados..."
                git stash pop 2>/dev/null || print_warning "Revisa con: git stash list"
            fi
        else
            print_error "Error al actualizar c√≥digo desde main"
            return 1
        fi
    else
        if git pull origin master; then
            print_success "C√≥digo actualizado desde master"
        else
            print_error "Error al actualizar c√≥digo"
            return 1
        fi
    fi
}

compile_app() {
    print_option "3Ô∏è‚É£ Compilando aplicaci√≥n Mattfuncional..."
    print_warning "Esto puede tomar varios minutos..."
    cd "$APP_DIR" || { print_error "Error: No se pudo cambiar al directorio del proyecto"; return 1; }
    if [ -x "./mvnw" ]; then
        ./mvnw clean package -DskipTests -q
    else
        mvn clean package -DskipTests -q
    fi
    if [ $? -eq 0 ]; then print_success "Compilaci√≥n exitosa"
    else print_error "Error en la compilaci√≥n"; return 1
    fi
}

start_app() {
    print_option "4Ô∏è‚É£ Iniciando aplicaci√≥n Mattfuncional..."
    cd "$APP_DIR" || { print_error "Error: No se pudo cambiar al directorio del proyecto"; return 1; }
    if [ ! -f "$JAR_PATH" ]; then
        print_error "No se encontr√≥ el JAR. Compila primero (opci√≥n 3)"
        return 1
    fi
    if command -v ss >/dev/null 2>&1; then
        if ss -tlnp 2>/dev/null | grep -q ":$APP_PORT "; then
            if ! pgrep -f "mattfuncional.*$JAR_NAME" > /dev/null; then
                print_error "Puerto $APP_PORT est√° ocupado por otra aplicaci√≥n"
                ss -tlnp | grep ":$APP_PORT " || true
                return 1
            fi
        fi
    else
        if netstat -tlnp 2>/dev/null | grep -q ":$APP_PORT " && ! pgrep -f "mattfuncional.*$JAR_NAME" > /dev/null; then
            print_error "Puerto $APP_PORT est√° ocupado"
            return 1
        fi
    fi
    mkdir -p "$(dirname "$LOG_FILE")"
    nohup java -Xmx512m -Xms256m \
        $JAVA_DB_OPTS \
        -Dspring.profiles.active=$SPRING_PROFILE \
        -Dserver.port=$APP_PORT \
        -Dserver.address=0.0.0.0 \
        -jar "$JAR_PATH" \
        >> "$LOG_FILE" 2>&1 &
    echo $! > "$PID_FILE"
    sleep 5
    if check_app_status; then
        print_success "Aplicaci√≥n Mattfuncional iniciada correctamente"
        echo -e "${CYAN}üåê Disponible en: http://149.50.144.53:$APP_PORT${NC}"
    else
        print_error "Error al iniciar la aplicaci√≥n"
        print_warning "Revisa los logs: tail -f $LOG_FILE"
    fi
}

full_deploy() {
    print_option "5Ô∏è‚É£ Despliegue completo iniciado..."
    stop_app
    update_code
    compile_app || return 1
    start_app
    echo ""
    print_success "üéâ Despliegue completo de Mattfuncional finalizado"
}

system_status() {
    print_option "6Ô∏è‚É£ Estado del sistema:"
    echo ""
    echo -e "${CYAN}=== APLICACI√ìN MATTFUNCIONAL ===${NC}"
    check_app_status
    echo ""
    echo -e "${CYAN}=== RECURSOS DEL SERVIDOR ===${NC}"
    echo "Uso de CPU y memoria:"
    top -bn1 | head -5
    echo ""
    echo -e "${CYAN}=== ESPACIO EN DISCO ===${NC}"
    df -h | grep -E "(Filesystem|/dev/)" | head -5
    echo ""
    echo -e "${CYAN}=== MEMORIA ===${NC}"
    free -h
    echo ""
    echo -e "${CYAN}=== PUERTO EN USO ===${NC}"
    if command -v ss >/dev/null 2>&1; then
        ss -tlnp | grep ":$APP_PORT " || echo "  No hay aplicaci√≥n en puerto $APP_PORT"
    else
        netstat -tlnp 2>/dev/null | grep ":$APP_PORT " || echo "  No hay aplicaci√≥n en puerto $APP_PORT"
    fi
}

view_logs() {
    print_option "7Ô∏è‚É£ Mostrando logs de la aplicaci√≥n Mattfuncional..."
    if [ -f "$LOG_FILE" ]; then
        echo -e "${YELLOW}√öltimas 50 l√≠neas de logs:${NC}"
        tail -50 "$LOG_FILE"
        echo ""
        echo -e "${BLUE}Para ver logs en tiempo real: opci√≥n 12${NC}"
    elif [ -f "$APP_DIR/nohup.out" ]; then
        echo -e "${YELLOW}√öltimas 50 l√≠neas de logs:${NC}"
        tail -50 "$APP_DIR/nohup.out"
        echo ""
        echo -e "${BLUE}Para ver logs en tiempo real: opci√≥n 12${NC}"
    else
        print_warning "No se encontr√≥ archivo de logs"
    fi
}

view_logs_live() {
    print_option "1Ô∏è‚É£2Ô∏è‚É£ Ver logs en vivo (streaming)..."
    local log_to_use="$LOG_FILE"
    [ ! -f "$log_to_use" ] && log_to_use="$APP_DIR/nohup.out"
    if [ -f "$log_to_use" ]; then
        echo -e "${YELLOW}Mostrando logs en tiempo real. Presiona Ctrl+C para volver al men√∫.${NC}"
        echo ""
        tail -f "$log_to_use"
    else
        print_warning "No se encontr√≥ archivo de logs"
    fi
}

install_mysql_workbench() {
    print_option "1Ô∏è‚É£3Ô∏è‚É£ Instalando MySQL Workbench (versi√≥n de escritorio con interfaz gr√°fica)..."
    if command -v mysql-workbench >/dev/null 2>&1; then
        print_success "MySQL Workbench ya est√° instalado: $(mysql-workbench --version 2>/dev/null || echo 'instalado')"
        return 0
    fi
    echo "Intentando instalar MySQL Workbench..."
    # Probar snap (com√∫n en Ubuntu 24.04)
    if command -v snap >/dev/null 2>&1 && snap install mysql-workbench-community 2>/dev/null; then
        print_success "MySQL Workbench instalado v√≠a snap"
        return 0
    fi
    # Probar apt (paquete de Ubuntu)
    if apt-get update -qq 2>/dev/null && apt-get install -y mysql-workbench 2>/dev/null; then
        print_success "MySQL Workbench instalado correctamente"
        return 0
    fi
    # Probar mysql-workbench-community si existe el repo MySQL
    if apt-get install -y mysql-workbench-community 2>/dev/null; then
        print_success "MySQL Workbench instalado correctamente"
        return 0
    fi
    print_error "No se pudo instalar. Prueba manualmente: snap install mysql-workbench-community"
    print_warning "En Ubuntu Server sin escritorio, MySQL Workbench requiere X11 forwarding (ssh -X) o sesi√≥n VNC con entorno gr√°fico."
    return 1
}

run_mysql_workbench() {
    print_option "1Ô∏è‚É£4Ô∏è‚É£ Ejecutando MySQL Workbench..."
    local wb_cmd=""
    command -v mysql-workbench >/dev/null 2>&1 && wb_cmd="mysql-workbench"
    [ -z "$wb_cmd" ] && command -v mysql-workbench-community >/dev/null 2>&1 && wb_cmd="mysql-workbench-community"
    [ -z "$wb_cmd" ] && [ -f /snap/bin/mysql-workbench-community ] && wb_cmd="/snap/bin/mysql-workbench-community"
    if [ -z "$wb_cmd" ]; then
        print_warning "MySQL Workbench no est√° instalado. Ejecut√° primero la opci√≥n 13."
        return 1
    fi
    echo -e "${YELLOW}Iniciando MySQL Workbench en segundo plano...${NC}"
    echo "Conexi√≥n sugerida: Host 127.0.0.1, Usuario mattfuncional_user, Puerto 3306"
    $wb_cmd &
    print_success "MySQL Workbench iniciado. Si us√°s SSH, necesit√°s X11 forwarding (ssh -X) para ver la interfaz."
}

restart_app() {
    print_option "8Ô∏è‚É£ Reiniciando aplicaci√≥n Mattfuncional..."
    stop_app
    sleep 2
    start_app
}

project_info() {
    print_option "9Ô∏è‚É£ Informaci√≥n del proyecto Mattfuncional:"
    cd "$APP_DIR" || { print_error "Error: No se pudo cambiar al directorio del proyecto"; return 1; }
    echo ""
    echo -e "${CYAN}=== INFORMACI√ìN GIT ===${NC}"
    echo "Rama actual: $(git branch --show-current 2>/dev/null || echo 'N/A')"
    echo "√öltimo commit: $(git log -1 --oneline 2>/dev/null || echo 'N/A')"
    echo "Estado: $(git status --porcelain 2>/dev/null | wc -l) archivos modificados"
    echo ""
    echo -e "${CYAN}=== INFORMACI√ìN DEL PROYECTO ===${NC}"
    echo "Directorio: $APP_DIR"
    echo "JAR disponible: $([ -f "$JAR_PATH" ] && echo "S√≠" || echo "No")"
    echo "Tama√±o del JAR: $([ -f "$JAR_PATH" ] && du -h "$JAR_PATH" | cut -f1 || echo "N/A")"
    echo ""
    echo -e "${CYAN}=== CONFIGURACI√ìN ===${NC}"
    echo "Servidor: Donweb | IP: 149.50.144.53 | Puerto: $APP_PORT | Perfil: $SPRING_PROFILE | BD: mattfuncional"
    echo ""
    echo -e "${CYAN}=== APLICACI√ìN MATTFUNCIONAL ===${NC}"
    check_app_status
}

disk_space() {
    print_option "üîü Espacio en disco:"
    echo ""
    echo -e "${CYAN}=== ESPACIO TOTAL DEL SERVIDOR ===${NC}"
    df -h / | awk 'NR==1 || NR==2 {print}'
    USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
    AVAILABLE=$(df -h / | tail -1 | awk '{print $4}')
    USED=$(df -h / | tail -1 | awk '{print $3}')
    TOTAL=$(df -h / | tail -1 | awk '{print $2}')
    echo ""
    echo -e "${BLUE}üìä Resumen:${NC}"
    echo "  Total: $TOTAL | Usado: $USED | Disponible: $AVAILABLE | Uso: ${USAGE}%"
    if [ "$USAGE" -ge 90 ]; then print_error "‚ö†Ô∏è  CR√çTICO: Espacio en disco muy bajo (${USAGE}%)"
    elif [ "$USAGE" -ge 80 ]; then print_warning "‚ö†Ô∏è  Espacio en disco bajo (${USAGE}%)"
    else print_success "Espacio en disco OK (${USAGE}%)"
    fi
    echo ""
    echo -e "${CYAN}=== PROYECTO MATTFUNCIONAL ===${NC}"
    [ -d "$APP_DIR" ] && echo "üì¶ Proyecto ($APP_DIR):" && du -sh "$APP_DIR" 2>/dev/null | awk '{print "   Tama√±o: " $1}'
    [ -d "/home/mattfuncional/uploads" ] && echo "üìÅ Uploads (/home/mattfuncional/uploads):" && du -sh /home/mattfuncional/uploads 2>/dev/null | awk '{print "   Tama√±o: " $1}'
    echo ""
    echo -e "${CYAN}=== TOP DIRECTORIOS EN /root ===${NC}"
    du -h --max-depth=1 /root 2>/dev/null | sort -hr | head -10 | awk '{printf "  %-50s %s\n", $2, $1}'
}

# Men√∫ principal
while true; do
    clear
    print_header
    echo ""
    check_app_status
    echo ""
    print_option "Selecciona una opci√≥n:"
    echo ""
    echo "1.  Parar aplicaci√≥n Mattfuncional"
    echo "2.  Actualizar c√≥digo (git pull)"
    echo "3.  Compilar aplicaci√≥n Mattfuncional"
    echo "4.  Iniciar aplicaci√≥n Mattfuncional"
    echo "5.  Despliegue completo (1+2+3+4)"
    echo "6.  Ver estado del sistema"
    echo "7.  Ver logs de la aplicaci√≥n"
    echo "8.  Reiniciar aplicaci√≥n Mattfuncional"
    echo "9.  Informaci√≥n del proyecto"
    echo "10. Ver espacio en disco"
    echo "11. Salir"
    echo "12. Ver logs en vivo (streaming)"
    echo "13. Instalar MySQL Workbench"
    echo "14. Ejecutar MySQL Workbench"
    echo ""
    read -p "Ingresa tu opci√≥n (1-14): " opcion
    echo ""

    case $opcion in
        1) stop_app ;;
        2) update_code ;;
        3) compile_app ;;
        4) start_app ;;
        5) full_deploy ;;
        6) system_status ;;
        7) view_logs ;;
        8) restart_app ;;
        9) project_info ;;
        10) disk_space ;;
        11)
            print_success "Saliendo del men√∫..."
            exit 0
            ;;
        12) view_logs_live ;;
        13) install_mysql_workbench ;;
        14) run_mysql_workbench ;;
        *)
            print_error "Opci√≥n inv√°lida. Presiona Enter para continuar..."
            read
            ;;
    esac

    echo ""
    read -p "Presiona Enter para continuar..."
done
