<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Panel del Usuario</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <link href="/css/footer.css" rel="stylesheet">
    <!-- WebSocket Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { background: #e3f2fd; }
        .section-title { color: #1976d2; font-weight: 700; margin-bottom: 1rem; }
        .card-rutina { border-radius: 15px; box-shadow: 0 2px 8px #1976d233; margin-bottom: 1.5rem; }
        .badge-estado { font-size: 0.95em; }
        .avatar-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #1976d2; }
        .btn-editar { background: linear-gradient(135deg, #1976d2 0%, #64b5f6 100%); color: white; font-weight: 600; }
        .btn-editar:hover { background: linear-gradient(135deg, #1565c0 0%, #1976d2 100%); color: white; }
    </style>
</head>
<body class="bg-light">

<!-- Navbar fragment -->
<div th:replace="fragments/navbar :: navbar"></div>

<div class="container mt-4">
    <div class="d-flex align-items-center mb-4">
        <img th:src="@{${#strings.isEmpty(usuario.avatar) ? '/img/not_imagen.png' : usuario.avatar}}" alt="Avatar" class="avatar-img me-3">
        <div>
            <h2 class="mb-0">¡Hola, <span th:text="${usuario.nombre}"></span>!</h2>
            <small class="text-muted" th:text="${usuario.correo}"></small>
        </div>
        <div class="ms-auto">
            <a th:href="@{'/usuario/editar/' + ${usuario.id}}" class="btn btn-editar"><i class="fas fa-key me-1"></i> Modificar Contraseña</a>
        </div>
    </div>

    <!-- Sección de Mensajería con el Profesor -->
    <div class="card mb-4" style="border-radius: 15px; box-shadow: 0 2px 8px #1976d233;">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h4 class="section-title mb-0"><i class="fas fa-envelope-open-text me-2"></i>Mensajes con tu profesor</h4>
            </div>
            <div class="mt-3" id="conversacion-mensajes" style="max-height: 320px; overflow-y: auto; background: #f8fafc; border-radius: 10px; padding: 1rem; min-height: 120px;">
                <div class="text-muted">Cargando mensajes...</div>
            </div>
            <form id="form-mensaje" class="d-flex gap-2 mt-2">
                <input class="form-control" id="input-mensaje" placeholder="Escribe un mensaje..." autocomplete="off" />
                <button type="submit" class="btn btn-primary d-flex align-items-center justify-content-center" style="width: 44px; height: 44px;">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Espacio reservado para Datos Físicos, IMC e Historial -->
    <div class="card mb-4" style="border-radius: 15px; box-shadow: 0 2px 8px #1976d233;">
        <div class="card-body">
            <h4 class="section-title mb-3"><i class="fas fa-dumbbell me-2"></i>Datos físicos e historial (próximamente)</h4>
            <div class="alert alert-info mb-0">Aquí verás tus datos físicos, IMC y evolución histórica.</div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4" id="rutinasTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="enproceso-tab" data-bs-toggle="tab" data-bs-target="#enproceso" type="button" role="tab">En proceso</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="terminadas-tab" data-bs-toggle="tab" data-bs-target="#terminadas" type="button" role="tab">Terminadas</button>
        </li>
    </ul>
    <div class="tab-content" id="rutinasTabsContent">
        <!-- Rutinas en proceso -->
        <div class="tab-pane fade show active" id="enproceso" role="tabpanel">
            <div th:if="${rutinasEnProceso.size() == 0}" class="alert alert-info">No tienes rutinas en proceso.</div>
            <div th:each="rutina : ${rutinasEnProceso}" class="card card-rutina p-3 mb-3">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h4 th:text="${rutina.nombre}" class="mb-1"></h4>
                        <span class="badge bg-info me-2" th:text="${rutina.fechaCreacion != null ? rutina.fechaCreacion.toLocalDate() : 'Sin fecha'}"></span>
                        <span class="badge bg-success me-2" th:text="${rutina.categoria != null ? rutina.categoria : 'Sin categoría'}"></span>
                        <span class="badge bg-warning text-dark badge-estado">En proceso</span>
                    </div>
                    <div>
                        <a th:href="@{'/rutinas/ver/' + ${rutina.id}}" class="btn btn-outline-primary btn-sm"><i class="fas fa-eye me-1"></i> Ver hoja de rutina</a>
                    </div>
                </div>
            </div>
        </div>
        <!-- Rutinas terminadas -->
        <div class="tab-pane fade" id="terminadas" role="tabpanel">
            <div th:if="${rutinasTerminadas.size() == 0}" class="alert alert-info">No tienes rutinas terminadas.</div>
            <div th:each="rutina : ${rutinasTerminadas}" class="card card-rutina p-3 mb-3 bg-light">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h4 th:text="${rutina.nombre}" class="mb-1"></h4>
                        <span class="badge bg-info me-2" th:text="${rutina.fechaCreacion != null ? rutina.fechaCreacion.toLocalDate() : 'Sin fecha'}"></span>
                        <span class="badge bg-success me-2" th:text="${rutina.categoria}"></span>
                        <span class="badge bg-secondary badge-estado">Terminada</span>
                    </div>
                    <div>
                        <a th:href="@{'/rutinas/ver/' + ${rutina.id}}" class="btn btn-outline-primary btn-sm"><i class="fas fa-eye me-1"></i> Ver hoja de rutina</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    // Variables globales
const usuarioId = [[${usuario.id}]];
let profesorId = null;
    let autoRefreshInterval;
let mensajesPrevios = [];

    // Función para cargar mensajes
    function cargarMensajes() {
        if (!profesorId) {
            console.log('ProfesorId no disponible aún');
            return;
        }
        
        console.log('Cargando mensajes... usuarioId:', usuarioId, 'profesorId:', profesorId);
        fetch(`/api/mensajes/conversacion?usuario1Id=${usuarioId}&usuario2Id=${profesorId}`)
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Mensajes recibidos:', data);
                if (mensajesSonIguales(data, mensajesPrevios)) return;
                mensajesPrevios = data;
                renderizarMensajes(data);
                
                // Marcar mensajes como leídos si hay mensajes nuevos del profesor
                const mensajesNoLeidos = data.filter(m => m.tipoEmisor === 'PROFESOR' && !m.leido);
                if (mensajesNoLeidos.length > 0) {
                    marcarMensajesComoLeidos();
                }
            })
            .catch(error => {
                console.error('Error cargando mensajes:', error);
                document.getElementById('conversacion-mensajes').innerHTML = 
                    '<div class="text-danger">Error cargando mensajes: ' + error.message + '</div>';
            });
    }
    
    // Función para marcar mensajes como leídos
    function marcarMensajesComoLeidos() {
        fetch(`/usuarios/api/usuarios/${usuarioId}/mensajes/leer`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Mensajes marcados como leídos:', data.mensajesLeidos);
            }
        })
        .catch(error => {
            console.error('Error marcando mensajes como leídos:', error);
        });
    }

    // Función para comparar mensajes
function mensajesSonIguales(a, b) {
    if (!Array.isArray(a) || !Array.isArray(b)) return false;
    if (a.length !== b.length) return false;
    
    for (let i = 0; i < a.length; i++) {
        const msgA = a[i];
        const msgB = b[i];
        if (!msgA || !msgB) return false;
        
        if (msgA.id && msgB.id) {
            if (msgA.id !== msgB.id) return false;
        } else {
            if (msgA.contenido !== msgB.contenido || 
                msgA.fecha !== msgB.fecha ||
                msgA.tipoEmisor !== msgB.tipoEmisor) {
                return false;
            }
        }
    }
    return true;
}

    // Función para renderizar mensajes
    function renderizarMensajes(data) {
    const cont = document.getElementById('conversacion-mensajes');
        if (!data || data.length === 0) {
            cont.innerHTML = '<div class="text-muted">No hay mensajes aún.</div>';
        return;
    }
        
        cont.innerHTML = data.map(m => {
            const esUsuario = m.tipoEmisor === 'USUARIO';
            return `<div class="d-flex mb-2 ${esUsuario ? 'justify-content-end' : 'justify-content-start'}" data-mensaje-id="${m.id}">
                <div class="chat-bubble ${esUsuario ? 'bg-primary text-white align-self-end' : 'bg-white text-dark align-self-start'}" style="max-width: 70%; border-radius: 16px; padding: 8px 16px; position: relative;">
                    <span class="badge ${esUsuario ? 'bg-primary' : 'bg-info text-dark'} mb-1" style="font-size: 0.75em;">${esUsuario ? 'Tú' : 'Profesor'}</span>
                    <span>${m.contenido}</span>
                    <div class="text-end" style="font-size: 0.75em; color: #888;">${m.fecha ? m.fecha.replace('T', ' ').substring(0, 16) : ''}</div>
        </div>
            </div>`;
        }).join('');
    cont.scrollTop = cont.scrollHeight;
    }

    // Función para iniciar auto-refresh
    function iniciarAutoRefresh() {
        // Cargar mensajes iniciales
        cargarMensajes();
        
        // Configurar intervalo de auto-refresh
        autoRefreshInterval = setInterval(() => {
            cargarMensajes();
        }, 30000); // 30 segundos
    }

    // Función para detener auto-refresh
    function detenerAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }

    // Función para enviar mensaje
    function enviarMensaje(event) {
        event.preventDefault();
        
    const input = document.getElementById('input-mensaje');
        const contenido = input.value.trim();
        
        if (!contenido || !profesorId) {
            console.log('No se puede enviar mensaje:', { contenido, profesorId });
        return;
    }
    
        const formData = new FormData();
        formData.append('receptorId', profesorId);
        formData.append('contenido', contenido);
    
    fetch('/api/mensajes/enviar', {
        method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            input.value = '';
            
            // Recargar mensajes inmediatamente después de enviar
            setTimeout(() => {
                cargarMensajes();
            }, 500);
        })
        .catch(error => {
            console.error('Error enviando mensaje:', error);
        });
    }

    // Inicializar cuando se carga la página
    document.addEventListener('DOMContentLoaded', function() {
        // Marcar mensajes como leídos inmediatamente al cargar la página
        marcarMensajesComoLeidos();
        
        // Si es acceso como admin, usar el profesorId que se pasa directamente
        const esAccesoComoAdmin = [[${esAccesoComoAdmin}]];
        const profesorIdDirecto = [[${profesorId}]];
        
        if (esAccesoComoAdmin && profesorIdDirecto) {
            profesorId = profesorIdDirecto;
            console.log('Acceso como admin - ProfesorId directo:', profesorId);
            iniciarAutoRefresh();
        } else {
            // Obtener ID del profesor desde la API (acceso normal)
            fetch(`/usuarios/api/usuarios/${usuarioId}/profesor`)
                .then(response => response.json())
                .then(data => {
                    profesorId = data.profesorId;
                    console.log('ProfesorId obtenido:', profesorId);
                    
                    if (profesorId) {
                        // Iniciar auto-refresh solo después de obtener el profesorId
                        iniciarAutoRefresh();
                    } else {
                        console.error('No se pudo obtener el profesorId');
                        document.getElementById('conversacion-mensajes').innerHTML = 
                            '<div class="text-muted">No tienes profesor asignado.</div>';
                    }
                })
                .catch(error => {
                    console.error('Error obteniendo profesorId:', error);
                    document.getElementById('conversacion-mensajes').innerHTML = 
                        '<div class="text-muted">Error cargando mensajes.</div>';
                });
        }
        
        // Configurar evento de envío
        document.getElementById('form-mensaje').addEventListener('submit', enviarMensaje);
        document.getElementById('input-mensaje').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                enviarMensaje(e);
            }
        });
        
        // Detener auto-refresh al cerrar la página
        window.addEventListener('beforeunload', function() {
            detenerAutoRefresh();
        });
    });
</script>

<!-- Footer Fragment -->
<div th:replace="fragments/footer :: footer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

