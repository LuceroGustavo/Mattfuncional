<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Semanal - Profesor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/style.css}" rel="stylesheet">
    <style>
        .calendario-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .calendario-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .calendario-header {
            background: linear-gradient(135deg, #0b6cda 0%, #1e88e5 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .calendario-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .calendario-header .fecha-semana {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .navegacion-calendario {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .btn-navegacion {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        
        .btn-navegacion:hover {
            background: rgba(255,255,255,0.3);
            color: white;
            transform: translateY(-2px);
        }
        
        .estadisticas-grid {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .estadisticas-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .estadistica-valor {
            font-size: 2rem;
            font-weight: 700;
            color: #0b6cda;
        }
        
        .estadistica-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .calendario-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 20px;
        }
        
        .tabla-horarios {
            width: 100%;
            table-layout: fixed;
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
        }
        
        .tabla-horarios th, .tabla-horarios td {
            min-width: 80px;
            max-width: 120px;
            text-align: center;
            vertical-align: middle;
            font-family: 'Segoe UI', 'Arial', sans-serif;
            padding: 8px 4px;
        }
        
        .tabla-horarios th {
            background: #f8f9fa;
            border: none;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            color: #495057;
        }
        
        /* Encabezado de día clicable */
        .tabla-horarios th.columna-dia-header {
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .tabla-horarios th.columna-dia-header:hover {
            background: #e9ecef;
        }
        /* Columna del día resaltada al hacer clic (pastel tenue) */
        .tabla-horarios th.columna-destacada,
        .tabla-horarios td.columna-destacada {
            background: #e8eaf6 !important; /* Lavanda pastel muy tenue */
        }
        .tabla-horarios th.columna-destacada {
            background: #c5cae9 !important; /* Un poco más visible en el encabezado */
        }
        .tabla-horarios td.columna-destacada.slot-disponible { background: linear-gradient(135deg, #c5cae9 0%, #b0bdd4 100%) !important; }
        .tabla-horarios td.columna-destacada.slot-moderado { background: linear-gradient(135deg, #d1c4e9 0%, #c5cae9 100%) !important; }
        .tabla-horarios td.columna-destacada.slot-ocupado { background: linear-gradient(135deg, #ce93d8 0%, #ba68c8 100%) !important; }
        .tabla-horarios td.columna-destacada.slot-vacio { background: #e8eaf6 !important; }
        
        .tabla-horarios td {
            border: 1px solid #e9ecef;
            padding: 8px;
            min-height: 60px;
            vertical-align: middle;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .tabla-horarios td:hover {
            background: #f8f9fa;
            transform: scale(1.02);
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .slot-disponible {
            background: linear-gradient(135deg, #b7e4c7 0%, #a3c585 100%) !important; /* Verde pastel/oliva */
            color: #2d4739;
        }
        .slot-moderado {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe082 100%) !important; /* Amarillo pastel */
            color: #665c1e;
        }
        .slot-ocupado {
            background: linear-gradient(135deg, #ffb3b3 0%, #ff8a8a 100%) !important; /* Rojo pastel */
            color: #7a2323;
        }
        .slot-vacio {
            background: #f8f9fa !important;
        }
        
        .usuarios-lista {
            font-size: 1.1rem; /* Más grande */
            font-weight: 600;
            color: #2d4739;
            margin-top: 5px;
            font-family: 'Segoe UI', 'Arial', sans-serif;
        }
        
        .usuario-item {
            background: rgba(255,255,255,0.4);
            padding: 4px 10px;
            border-radius: 10px;
            margin: 2px 0;
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        
        .capacidad-info {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.6rem;
        }
        
        .modal-usuarios .modal-header {
            background: linear-gradient(135deg, #0b6cda 0%, #1e88e5 100%);
            color: white;
        }
        
        .usuario-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #0b6cda;
        }
        
        .usuario-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .btn-volver-panel {
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 7px 16px;
            font-size: 1em;
            font-weight: 500;
            margin-bottom: 10px;
            margin-right: 10px;
            transition: background 0.2s;
            box-shadow: 0 2px 8px rgba(25,118,210,0.08);
        }
        
        .btn-volver-panel:hover {
            background: #125ea2;
            color: #fff;
        }
        
        @media (max-width: 1200px) {
            .calendario-card { margin: 0 10px; }
            .tabla-horarios th, .tabla-horarios td { 
                min-width: 60px; 
                max-width: 80px; 
                font-size: 0.85em; 
            }
        }
    </style>
</head>
<body>
    <div class="calendario-container">
        <div class="container-fluid">
            <div class="calendario-card">
                <!-- Header del Calendario -->
                <div class="calendario-header">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <h1><i class="fas fa-calendar-alt"></i> Calendario Semanal</h1>
                            <div class="fecha-semana">
                                <span th:text="${calendario.fechaInicioSemana} + ' - ' + ${calendario.fechaFinSemana}">Semana actual</span>
                            </div>
                        </div>
                        <div class="fs-4 fw-semibold">
                            <span th:text="${#strings.capitalize(#temporals.format(calendario.fechaInicioSemana, 'MMMM'))}">Mes</span>
                        </div>
                    </div>
                    
                    <!-- Navegación -->
                    <div class="navegacion-calendario">
                        <a th:href="@{/calendario/semanal/profesor/{id}(id=${profesorId}, fecha=${calendario.fechaInicioSemana.minusWeeks(1)})}" 
                           class="btn btn-navegacion">
                            <i class="fas fa-chevron-left"></i> Semana Anterior
                        </a>
                        <a th:href="@{/calendario/semanal/profesor/{id}(id=${profesorId})}" 
                           class="btn btn-navegacion">
                            <i class="fas fa-calendar-day"></i> Hoy
                        </a>
                        <a th:href="@{/calendario/semanal/profesor/{id}(id=${profesorId}, fecha=${calendario.fechaInicioSemana.plusWeeks(1)})}" 
                           class="btn btn-navegacion">
                            Semana Siguiente <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>
                </div>
                
                <!-- Contenido del Calendario -->
                <div class="p-4">
                    <!-- Botón Volver -->
                    <div style="display: flex; align-items: center; justify-content: flex-start;">
                        <a href="/profesor/dashboard" class="btn-volver-panel">
                            <span title="Volver al panel"><i class="bi bi-arrow-left-circle"></i></span> Volver al Panel
                        </a>
                    </div>
                    
                    <!-- Estadísticas -->
                    <div class="estadisticas-grid" style="display: flex; justify-content: space-between; align-items: stretch; gap: 20px; margin-bottom: 30px;">
                        <div class="estadisticas-card d-flex flex-column justify-content-center align-items-center" style="flex:1;">
                            <div class="estadistica-valor" style="text-align: center;" th:text="${estadisticas['totalUsuarios']}">0</div>
                            <div class="estadistica-label" style="text-align: center;">Total Alumnos</div>
                        </div>
                        <div class="estadisticas-card d-flex flex-column justify-content-center align-items-center" style="flex:1;">
                            <div class="estadistica-valor" style="text-align: center;" th:text="${estadisticas['capacidadMaxima']}">0</div>
                            <div class="estadistica-label" style="text-align: center;">Capacidad de usuarios x Día</div>
                        </div>
                        <div class="estadisticas-card d-flex flex-column justify-content-end align-items-end" style="flex:1;">
                            <div class="w-100 d-flex flex-row align-items-center justify-content-end">
                                <div class="progress w-75 me-2" style="height: 8px; min-width: 100px; max-width: 200px;">
                                    <div class="progress-bar bg-success" role="progressbar" th:style="'width: ' + ${estadisticas['porcentajeOcupacion']} + '%'" th:aria-valuenow="${estadisticas['porcentajeOcupacion']}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div class="estadistica-valor" style="text-align: right; min-width: 40px;" th:text="${#numbers.formatDecimal(estadisticas['porcentajeOcupacion'], 0, 'POINT', 0, 'COMMA')} + '%'">0%</div>
                            </div>
                            <div class="estadistica-label" style="text-align: right; width: 100%;">Ocupación semanal</div>
                            <!-- Leyenda de colores -->
                            <div class="d-flex flex-row justify-content-end align-items-center mt-2" style="gap: 16px; width: 100%;">
                                <div class="d-flex align-items-center"><span style="display:inline-block;width:18px;height:18px;background:linear-gradient(135deg,#b7e4c7 0%,#a3c585 100%);border-radius:4px;margin-right:6px;"></span><span style="font-size:0.95em;">Disponible</span></div>
                                <div class="d-flex align-items-center"><span style="display:inline-block;width:18px;height:18px;background:linear-gradient(135deg,#fff3cd 0%,#ffe082 100%);border-radius:4px;margin-right:6px;"></span><span style="font-size:0.95em;">Parcialmente ocupado</span></div>
                                <div class="d-flex align-items-center"><span style="display:inline-block;width:18px;height:18px;background:linear-gradient(135deg,#ffb3b3 0%,#ff8a8a 100%);border-radius:4px;margin-right:6px;"></span><span style="font-size:0.95em;">Ocupado / Sin lugar</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Formulario para modificar capacidad máxima -->
                    <form th:action="@{/calendario/actualizar-capacidad-maxima}" method="post" class="mb-4 d-flex align-items-center">
                        <label for="capacidadMaxima" class="me-2 mb-0">Capacidad de usuarios x Día:</label>
                        <input type="number" id="capacidadMaxima" name="capacidadMaxima" min="1" max="100" th:value="${estadisticas.capacidadMaxima}" class="form-control w-auto me-2" required>
                        <input type="hidden" name="profesorId" th:value="${profesorId}" />
                        <button type="submit" class="btn btn-primary">Actualizar</button>
                    </form>
                    
                    <!-- Tabla de horarios -->
                    <div class="calendario-table">
                        <table class="table table-bordered text-center align-middle mt-4 tabla-horarios">
                            <thead>
                                <tr>
                                    <th>Hora</th>
                                    <th th:each="dia, diaStat : ${diasSemana}"
                                        th:with="fechaDia=${calendario.fechaInicioSemana.plusDays(diaStat.index)}"
                                        th:text="${dia + ' ' + #temporals.format(fechaDia, 'dd')}"
                                        class="columna-dia-header"
                                        th:attr="data-col-index=${diaStat.index}"
                                        title="Clic para resaltar esta columna"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="i : ${#numbers.sequence(0, totalFilas - 1)}">
                                    <td th:text="${horas[i] != null ? horas[i] : ''}"></td>
                                    <td th:each="dia, diaStat : ${diasSemana}"
                                        th:with="slot=${slotsPorDiaList[diaStat.index][i]}"
                                        th:attr="data-col-index=${diaStat.index}"
                                        th:classappend="${slot.capacidadActual == 0 ? 'slot-disponible' : (slot.capacidadActual == slot.capacidadMaxima ? 'slot-ocupado' : (slot.capacidadActual >= 0.7 * slot.capacidadMaxima ? 'slot-moderado' : 'slot-disponible'))}"
                                        style="cursor:pointer; position:relative;"
                                        th:title="${slot.capacidadActual == slot.capacidadMaxima ? 'Capacidad al máximo' : ''}">
                                        <div th:if="${slot.usuariosAsignados != null and !#lists.isEmpty(slot.usuariosAsignados)}" class="usuarios-lista">
                                            <div th:each="usuario : ${slot.usuariosAsignados}" class="usuario-item" th:text="${usuario.nombre}"></div>
                                        </div>
                                        <div th:if="${slot.usuariosAsignados == null or #lists.isEmpty(slot.usuariosAsignados)}">-</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para mostrar usuarios -->
    <div class="modal fade" id="modalUsuarios" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-users"></i> 
                        <span id="modalTitulo">Usuarios en el horario</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Contenido dinámico -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function mostrarUsuarios(dia, horario) {
            const modal = new bootstrap.Modal(document.getElementById('modalUsuarios'));
            const titulo = document.getElementById('modalTitulo');
            const body = document.getElementById('modalBody');
            
            titulo.textContent = `Usuarios - ${dia} ${horario}`;
            
            // Aquí puedes hacer una llamada AJAX para obtener los usuarios
            // Por ahora mostraremos un mensaje
            body.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Funcionalidad en desarrollo. Aquí se mostrarán los usuarios registrados para ${dia} ${horario}.
                </div>
            `;
            
            modal.show();
        }

        // Resaltar columna del día al hacer clic en el encabezado (pastel tenue); otro clic quita el resaltado
        (function() {
            var tabla = document.querySelector('.tabla-horarios');
            if (!tabla) return;
            var headers = tabla.querySelectorAll('thead th.columna-dia-header[data-col-index]');
            headers.forEach(function(th) {
                th.addEventListener('click', function() {
                    var idx = this.getAttribute('data-col-index');
                    var celdas = tabla.querySelectorAll('th[data-col-index="' + idx + '"], td[data-col-index="' + idx + '"]');
                    var yaDestacada = this.classList.contains('columna-destacada');
                    if (yaDestacada) {
                        celdas.forEach(function(el) { el.classList.remove('columna-destacada'); });
                    } else {
                        tabla.querySelectorAll('th[data-col-index], td[data-col-index]').forEach(function(el) { el.classList.remove('columna-destacada'); });
                        celdas.forEach(function(el) { el.classList.add('columna-destacada'); });
                    }
                });
            });
        })();
    </script>
</body>
</html> 