<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Semanal - Profesor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/style.css}" rel="stylesheet">
    <style>
        .calendario-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .calendario-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .calendario-header {
            background: linear-gradient(135deg, #0b6cda 0%, #1e88e5 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .calendario-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .calendario-header .fecha-semana {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .navegacion-calendario {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .btn-navegacion {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        
        .btn-navegacion:hover {
            background: rgba(255,255,255,0.3);
            color: white;
            transform: translateY(-2px);
        }
        
        .estadisticas-grid {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .estadisticas-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .estadistica-valor {
            font-size: 2rem;
            font-weight: 700;
            color: #0b6cda;
        }
        
        .estadistica-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .calendario-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 20px;
        }
        
        .tabla-horarios {
            width: 100%;
            table-layout: fixed;
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
        }
        
        .tabla-horarios th, .tabla-horarios td {
            min-width: 80px;
            max-width: 120px;
            text-align: center;
            vertical-align: middle;
            font-family: 'Segoe UI', 'Arial', sans-serif;
            padding: 8px 4px;
        }
        
        .tabla-horarios th {
            background: #f8f9fa;
            border: none;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            color: #495057;
        }
        
        /* Encabezado de día clicable */
        .tabla-horarios th.columna-dia-header {
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .tabla-horarios th.columna-dia-header:hover {
            background: #e9ecef;
        }
        /* Columna del día resaltada al hacer clic (pastel tenue) */
        .tabla-horarios th.columna-destacada,
        .tabla-horarios td.columna-destacada {
            background: #e8eaf6 !important; /* Lavanda pastel muy tenue */
        }
        .tabla-horarios th.columna-destacada {
            background: #c5cae9 !important; /* Un poco más visible en el encabezado */
        }
        .tabla-horarios td.columna-destacada.slot-disponible { background: linear-gradient(135deg, #c5cae9 0%, #b0bdd4 100%) !important; }
        .tabla-horarios td.columna-destacada.slot-moderado { background: linear-gradient(135deg, #d1c4e9 0%, #c5cae9 100%) !important; }
        .tabla-horarios td.columna-destacada.slot-ocupado { background: linear-gradient(135deg, #ce93d8 0%, #ba68c8 100%) !important; }
        .tabla-horarios td.columna-destacada.slot-vacio { background: #e8eaf6 !important; }
        
        .tabla-horarios td {
            border: 1px solid #e9ecef;
            padding: 8px;
            min-height: 60px;
            vertical-align: middle;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .tabla-horarios td:hover {
            background: #f8f9fa;
            transform: scale(1.02);
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .slot-disponible {
            background: linear-gradient(135deg, #b7e4c7 0%, #a3c585 100%) !important; /* Verde pastel/oliva */
            color: #2d4739;
        }
        .slot-moderado {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe082 100%) !important; /* Amarillo pastel */
            color: #665c1e;
        }
        .slot-ocupado {
            background: linear-gradient(135deg, #ffb3b3 0%, #ff8a8a 100%) !important; /* Rojo pastel */
            color: #7a2323;
        }
        .slot-vacio {
            background: #f8f9fa !important;
        }
        
        .usuarios-lista {
            font-size: 1.1rem; /* Más grande */
            font-weight: 600;
            color: #2d4739;
            margin-top: 5px;
            font-family: 'Segoe UI', 'Arial', sans-serif;
        }
        
        .usuario-item {
            background: rgba(255,255,255,0.4);
            padding: 4px 10px;
            border-radius: 10px;
            margin: 2px 0;
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        .usuario-link {
            color: inherit;
            text-decoration: none;
        }
        .usuario-link:hover {
            text-decoration: underline;
        }
        .punto-asistencia {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .punto-presente { background: #28a745; }
        .punto-ausente { background: #dc3545; }
        .punto-pendiente { background: #6c757d; }
        .btn-punto-asistencia { cursor: pointer; }
        .btn-punto-asistencia:hover { opacity: 0.85; transform: scale(1.15); }
        
        .btn-excepcion {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            padding: 0;
            border-radius: 50%;
            font-size: 12px;
            line-height: 16px;
            opacity: 0.5;
        }
        .btn-excepcion:hover { opacity: 0.95; }
        .tabla-horarios:not(.excepcion-activa) .btn-excepcion { display: none; }

        .badge-excepcion {
            background: #6c757d;
            color: #fff;
            font-size: 0.6rem;
            padding: 1px 4px;
            border-radius: 6px;
            opacity: 0.85;
        }

        .capacidad-info {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.6rem;
        }
        
        .modal-usuarios .modal-header {
            background: linear-gradient(135deg, #0b6cda 0%, #1e88e5 100%);
            color: white;
        }
        
        .usuario-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #0b6cda;
        }
        
        .usuario-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .btn-volver-panel {
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 7px 16px;
            font-size: 1em;
            font-weight: 500;
            margin-bottom: 10px;
            margin-right: 10px;
            transition: background 0.2s;
            box-shadow: 0 2px 8px rgba(25,118,210,0.08);
        }
        
        .btn-volver-panel:hover {
            background: #125ea2;
            color: #fff;
        }
        
        @media (max-width: 1200px) {
            .calendario-card { margin: 0 10px; }
            .tabla-horarios th, .tabla-horarios td { 
                min-width: 60px; 
                max-width: 80px; 
                font-size: 0.85em; 
            }
        }
    </style>
</head>
<body>
    <div class="calendario-container">
        <div class="container-fluid">
            <div class="calendario-card">
                <!-- Header del Calendario -->
                <div class="calendario-header">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <h1><i class="fas fa-calendar-alt"></i> Calendario Semanal</h1>
                            <div class="fecha-semana">
                                <span th:text="${calendario.fechaInicioSemana} + ' - ' + ${calendario.fechaFinSemana}">Semana actual</span>
                            </div>
                        </div>
                        <div class="fs-4 fw-semibold">
                            <span th:text="${#strings.capitalize(#temporals.format(calendario.fechaInicioSemana, 'MMMM'))}">Mes</span>
                        </div>
                    </div>
                    
                    <!-- Navegación -->
                    <div class="navegacion-calendario">
                        <a th:href="@{/calendario/semanal/profesor/{id}(id=${profesorId}, fecha=${calendario.fechaInicioSemana.minusWeeks(1)})}" 
                           class="btn btn-navegacion">
                            <i class="fas fa-chevron-left"></i> Semana Anterior
                        </a>
                        <a th:href="@{/calendario/semanal/profesor/{id}(id=${profesorId})}" 
                           class="btn btn-navegacion">
                            <i class="fas fa-calendar-day"></i> Hoy
                        </a>
                        <a th:href="@{/calendario/semanal/profesor/{id}(id=${profesorId}, fecha=${calendario.fechaInicioSemana.plusWeeks(1)})}" 
                           class="btn btn-navegacion">
                            Semana Siguiente <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>
                </div>
                
                <!-- Contenido del Calendario -->
                <div class="p-4">
                    <!-- Botón Volver -->
                    <div style="display: flex; align-items: center; justify-content: flex-start;">
                        <a href="/profesor/dashboard" class="btn-volver-panel">
                            <span title="Volver al panel"><i class="bi bi-arrow-left-circle"></i></span> Volver al Panel
                        </a>
                    </div>
                    
                    <!-- Estadísticas -->
                    <div class="estadisticas-grid" style="display: flex; justify-content: space-between; align-items: stretch; gap: 20px; margin-bottom: 30px;">
                        <div class="estadisticas-card d-flex flex-column justify-content-center align-items-center" style="flex:1;">
                            <div class="estadistica-valor" style="text-align: center;" th:text="${estadisticas['totalUsuarios']}">0</div>
                            <div class="estadistica-label" style="text-align: center;">Total Alumnos</div>
                        </div>
                        <div class="estadisticas-card d-flex flex-column justify-content-center align-items-center" style="flex:1;">
                            <div class="estadistica-valor" style="text-align: center;" th:text="${estadisticas['capacidadMaxima']}">0</div>
                            <div class="estadistica-label" style="text-align: center;">Capacidad de usuarios x Día</div>
                        </div>
                        <div class="estadisticas-card d-flex flex-column justify-content-end align-items-end" style="flex:1;">
                            <div class="w-100 d-flex flex-row align-items-center justify-content-end">
                                <div class="progress w-75 me-2" style="height: 8px; min-width: 100px; max-width: 200px;">
                                    <div class="progress-bar bg-success" role="progressbar" th:style="'width: ' + ${estadisticas['porcentajeOcupacion']} + '%'" th:aria-valuenow="${estadisticas['porcentajeOcupacion']}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div class="estadistica-valor" style="text-align: right; min-width: 40px;" th:text="${#numbers.formatDecimal(estadisticas['porcentajeOcupacion'], 0, 'POINT', 0, 'COMMA')} + '%'">0%</div>
                            </div>
                            <div class="estadistica-label" style="text-align: right; width: 100%;">Ocupación semanal</div>
                            <!-- Leyenda de colores -->
                            <div class="d-flex flex-row justify-content-end align-items-center mt-2" style="gap: 16px; width: 100%;">
                                <div class="d-flex align-items-center"><span style="display:inline-block;width:18px;height:18px;background:linear-gradient(135deg,#b7e4c7 0%,#a3c585 100%);border-radius:4px;margin-right:6px;"></span><span style="font-size:0.95em;">Disponible</span></div>
                                <div class="d-flex align-items-center"><span style="display:inline-block;width:18px;height:18px;background:linear-gradient(135deg,#fff3cd 0%,#ffe082 100%);border-radius:4px;margin-right:6px;"></span><span style="font-size:0.95em;">Parcialmente ocupado</span></div>
                                <div class="d-flex align-items-center"><span style="display:inline-block;width:18px;height:18px;background:linear-gradient(135deg,#ffb3b3 0%,#ff8a8a 100%);border-radius:4px;margin-right:6px;"></span><span style="font-size:0.95em;">Ocupado / Sin lugar</span></div>
                                <div class="d-flex align-items-center ms-2"><span class="punto-asistencia punto-presente" style="margin-right:6px;"></span><span style="font-size:0.95em;">Presente</span></div>
                                <div class="d-flex align-items-center"><span class="punto-asistencia punto-ausente" style="margin-right:6px;"></span><span style="font-size:0.95em;">Ausente</span></div>
                                <div class="d-flex align-items-center"><span class="punto-asistencia punto-pendiente" style="margin-right:6px;"></span><span style="font-size:0.95em;">Pendiente</span></div>
                                <span style="font-size:0.85em;color:#666;">Clic en el punto para marcar presente/ausente.</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Formulario para modificar capacidad máxima -->
                    <div class="mb-4 d-flex align-items-center justify-content-between">
                        <form th:action="@{/calendario/actualizar-capacidad-maxima}" method="post" class="d-flex align-items-center">
                            <label for="capacidadMaxima" class="me-2 mb-0">Capacidad de usuarios x Día:</label>
                            <input type="number" id="capacidadMaxima" name="capacidadMaxima" min="1" max="100" th:value="${estadisticas.capacidadMaxima}" class="form-control w-auto me-2" required>
                            <input type="hidden" name="profesorId" th:value="${profesorId}" />
                            <button type="submit" class="btn btn-primary">Actualizar</button>
                        </form>
                        <button type="button" class="btn btn-outline-dark" id="toggleExcepciones">
                            Agregar usuarios por excepción
                        </button>
                    </div>
                    
                    <!-- Tabla de horarios -->
                    <div class="calendario-table">
                        <table class="table table-bordered text-center align-middle mt-4 tabla-horarios">
                            <thead>
                                <tr>
                                    <th>Hora</th>
                                    <th th:each="dia, diaStat : ${diasSemana}"
                                        th:with="fechaDia=${calendario.fechaInicioSemana.plusDays(diaStat.index)}"
                                        th:text="${dia + ' ' + #temporals.format(fechaDia, 'dd')}"
                                        class="columna-dia-header"
                                        th:attr="data-col-index=${diaStat.index}"
                                        title="Clic para resaltar esta columna"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="i : ${#numbers.sequence(0, totalFilas - 1)}">
                                    <td th:text="${horas[i] != null ? horas[i] : ''}"></td>
                                    <td th:each="dia, diaStat : ${diasSemana}"
                                        th:with="slot=${slotsPorDiaList[diaStat.index][i]}, fechaDia=${calendario.fechaInicioSemana.plusDays(diaStat.index)}"
                                        th:attr="data-col-index=${diaStat.index}, data-fecha=${#temporals.format(fechaDia, 'yyyy-MM-dd')}, data-hora-inicio=${slot.horaInicio}, data-hora-fin=${slot.horaFin}"
                                        th:classappend="${slot.capacidadActual == 0 ? 'slot-disponible' : (slot.capacidadActual == slot.capacidadMaxima ? 'slot-ocupado' : (slot.capacidadActual >= 0.7 * slot.capacidadMaxima ? 'slot-moderado' : 'slot-disponible'))}"
                                        style="cursor:pointer; position:relative;"
                                        th:title="${slot.capacidadActual == slot.capacidadMaxima ? 'Capacidad al máximo' : ''}">
                                        <button type="button" class="btn btn-light btn-excepcion" title="Agregar excepción">+</button>
                                        <div th:if="${slot.usuariosAsignados != null and !#lists.isEmpty(slot.usuariosAsignados)}" class="usuarios-lista">
                                            <div th:each="usuario : ${slot.usuariosAsignados}"
                                                th:with="presente=${slot.presentePorUsuarioId != null ? slot.presentePorUsuarioId[usuario.id] : null}, esExcepcion=${slot.excepcionPorUsuarioId != null ? slot.excepcionPorUsuarioId[usuario.id] : null}"
                                                class="usuario-item d-flex align-items-center justify-content-center gap-1">
                                                <span th:if="${fechaDia != null and (fechaDia.isBefore(#temporals.createNow().toLocalDate()) or fechaDia.isEqual(#temporals.createNow().toLocalDate()))}"
                                                    class="punto-asistencia btn-punto-asistencia"
                                                    th:classappend="${presente == true ? 'punto-presente' : (presente == false ? 'punto-ausente' : 'punto-pendiente')}"
                                                    th:attr="data-usuario-id=${usuario.id}, data-fecha=${#temporals.format(fechaDia, 'yyyy-MM-dd')}, data-estado=${presente == null ? 'PENDIENTE' : (presente == true ? 'PRESENTE' : 'AUSENTE')}, title=${presente == true ? 'Presente (clic para cambiar)' : (presente == false ? 'Ausente (clic para cambiar)' : 'Pendiente (clic para cambiar)')}"></span>
                                                <a th:href="@{/profesor/alumnos/{id}(id=${usuario.id})}" class="usuario-link" target="_blank" rel="noopener" th:text="${usuario.nombre}"></a>
                                                <span th:if="${esExcepcion == true}" class="badge-excepcion" title="Agregado por excepción">Ex</span>
                                            </div>
                                        </div>
                                        <div th:if="${slot.usuariosAsignados == null or #lists.isEmpty(slot.usuariosAsignados)}">-</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para mostrar usuarios -->
    <div class="modal fade" id="modalUsuarios" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-users"></i> 
                        <span id="modalTitulo">Usuarios en el horario</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Contenido dinámico -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para crear excepción -->
    <div class="modal fade" id="modalExcepcion" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus-circle"></i>
                        Agregar alumno por excepción
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/calendario/excepcion}" method="post" id="formExcepcion">
                    <div class="modal-body">
                        <div class="mb-2 text-muted" id="excepcionDetalle"></div>
                        <div class="mb-3">
                            <label for="excepcionUsuario" class="form-label">Alumno</label>
                            <select id="excepcionUsuario" name="usuarioId" class="form-select" required>
                                <option value="" disabled selected>Seleccionar alumno</option>
                                <option th:each="alumno : ${alumnosParaExcepcion}" th:value="${alumno.id}"
                                        th:text="${alumno.nombre}"></option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="excepcionMotivo" class="form-label">Motivo (opcional)</label>
                            <input type="text" id="excepcionMotivo" name="motivo" class="form-control" maxlength="255"
                                   placeholder="Ej: recuperación de clase">
                        </div>
                        <input type="hidden" id="excepcionFecha" name="fecha">
                        <input type="hidden" id="excepcionHoraInicio" name="horaInicio">
                        <input type="hidden" id="excepcionHoraFin" name="horaFin">
                        <input type="hidden" name="profesorId" th:value="${profesorId}">
                        <input type="hidden" name="fechaSemana" th:value="${fechaSemana}">
                        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar excepción</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        var urlMarcarAsistencia = /*[[@{/calendario/api/marcar-asistencia}]]*/ '/calendario/api/marcar-asistencia';
    </script>
    <script>
        function mostrarUsuarios(dia, horario) {
            const modal = new bootstrap.Modal(document.getElementById('modalUsuarios'));
            const titulo = document.getElementById('modalTitulo');
            const body = document.getElementById('modalBody');
            
            titulo.textContent = `Usuarios - ${dia} ${horario}`;
            
            // Aquí puedes hacer una llamada AJAX para obtener los usuarios
            // Por ahora mostraremos un mensaje
            body.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Funcionalidad en desarrollo. Aquí se mostrarán los usuarios registrados para ${dia} ${horario}.
                </div>
            `;
            
            modal.show();
        }

        // Resaltar columna del día al hacer clic en el encabezado (pastel tenue); otro clic quita el resaltado
        (function() {
            var tabla = document.querySelector('.tabla-horarios');
            if (!tabla) return;
            var headers = tabla.querySelectorAll('thead th.columna-dia-header[data-col-index]');
            headers.forEach(function(th) {
                th.addEventListener('click', function() {
                    var idx = this.getAttribute('data-col-index');
                    var celdas = tabla.querySelectorAll('th[data-col-index="' + idx + '"], td[data-col-index="' + idx + '"]');
                    var yaDestacada = this.classList.contains('columna-destacada');
                    if (yaDestacada) {
                        celdas.forEach(function(el) { el.classList.remove('columna-destacada'); });
                    } else {
                        tabla.querySelectorAll('th[data-col-index], td[data-col-index]').forEach(function(el) { el.classList.remove('columna-destacada'); });
                        celdas.forEach(function(el) { el.classList.add('columna-destacada'); });
                    }
                });
            });
        })();

        // Ciclo de 3 estados: PENDIENTE -> PRESENTE -> AUSENTE -> PENDIENTE (clic en el punto)
        (function() {
            var urlApi = (typeof urlMarcarAsistencia !== 'undefined' ? urlMarcarAsistencia : '/calendario/api/marcar-asistencia');
            var orden = ['PENDIENTE', 'PRESENTE', 'AUSENTE'];
            function siguienteEstado(actual) {
                var i = orden.indexOf(actual);
                return orden[(i + 1) % orden.length];
            }
            function clasePorEstado(estado) {
                return estado === 'PRESENTE' ? 'punto-presente' : (estado === 'AUSENTE' ? 'punto-ausente' : 'punto-pendiente');
            }
            function tituloPorEstado(estado) {
                return estado === 'PRESENTE' ? 'Presente (clic para cambiar)' : (estado === 'AUSENTE' ? 'Ausente (clic para cambiar)' : 'Pendiente (clic para cambiar)');
            }
            document.addEventListener('click', function(e) {
                var dot = e.target;
                if (!dot || !dot.classList || !dot.classList.contains('btn-punto-asistencia')) return;
                e.preventDefault();
                e.stopPropagation();
                var usuarioId = dot.getAttribute('data-usuario-id');
                var fecha = dot.getAttribute('data-fecha');
                var estadoActual = (dot.getAttribute('data-estado') || 'PENDIENTE').toUpperCase();
                if (!usuarioId || !fecha) return;
                var fechaHoy = new Date();
                var fechaSlot = new Date(fecha + 'T00:00:00');
                fechaHoy.setHours(0, 0, 0, 0);
                if (fechaSlot > fechaHoy) return;
                var nuevoEstado = siguienteEstado(estadoActual);
                var params = 'usuarioId=' + encodeURIComponent(usuarioId) + '&fecha=' + encodeURIComponent(fecha) + '&estado=' + encodeURIComponent(nuevoEstado);
                fetch(urlApi, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    body: params
                }).then(function(r) {
                    if (!r.ok) throw new Error('Error ' + r.status);
                    return r.json();
                }).then(function(data) {
                    if (data && data.ok === true && data.estado) {
                        var estado = data.estado;
                        dot.setAttribute('data-estado', estado);
                        dot.classList.remove('punto-presente', 'punto-ausente', 'punto-pendiente');
                        dot.classList.add(clasePorEstado(estado));
                        dot.setAttribute('title', tituloPorEstado(estado));
                    }
                }).catch(function(err) { console.error('Error al marcar asistencia:', err); });
            });
        })();

        // Abrir modal para agregar excepción desde el "+"
        (function() {
            var modalEl = document.getElementById('modalExcepcion');
            if (!modalEl) return;
            var modal = new bootstrap.Modal(modalEl);
            document.addEventListener('click', function(e) {
                var btn = e.target.closest('.btn-excepcion');
                if (!btn) return;
                e.preventDefault();
                e.stopPropagation();
                var td = btn.closest('td');
                if (!td) return;
                var fecha = td.getAttribute('data-fecha');
                var horaInicio = td.getAttribute('data-hora-inicio');
                var horaFin = td.getAttribute('data-hora-fin');
                var detalle = document.getElementById('excepcionDetalle');
                if (detalle) {
                    detalle.textContent = (fecha && horaInicio && horaFin)
                        ? (fecha + " - " + horaInicio + " a " + horaFin)
                        : "";
                }
                var inputFecha = document.getElementById('excepcionFecha');
                var inputHoraInicio = document.getElementById('excepcionHoraInicio');
                var inputHoraFin = document.getElementById('excepcionHoraFin');
                if (inputFecha) inputFecha.value = fecha || "";
                if (inputHoraInicio) inputHoraInicio.value = horaInicio || "";
                if (inputHoraFin) inputHoraFin.value = horaFin || "";
                modal.show();
            });
        })();

        // Toggle para habilitar/deshabilitar los "+"
        (function() {
            var toggleBtn = document.getElementById('toggleExcepciones');
            var tabla = document.querySelector('.tabla-horarios');
            if (!toggleBtn || !tabla) return;
            toggleBtn.addEventListener('click', function() {
                var activa = tabla.classList.toggle('excepcion-activa');
                toggleBtn.classList.toggle('btn-dark', activa);
                toggleBtn.classList.toggle('btn-outline-dark', !activa);
                toggleBtn.textContent = activa ? 'Desactivar excepciones' : 'Agregar usuarios por excepción';
            });
        })();
    </script>
</body>
</html> 