<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Administración de usuarios</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <style>
        body { background: linear-gradient(135deg, #e8eaf6 0%, #f3e5f5 100%); min-height: 100vh; }
        .card { border: none; border-radius: 1.25rem; box-shadow: 0 4px 16px rgba(0,0,0,0.06); }
        .table th { color: #5e35b1; font-weight: 600; }
    </style>
</head>
<body>
<div th:replace="fragments/navbar :: navbar"></div>

<div class="container-fluid py-4 px-4" style="background: linear-gradient(135deg, #e8eaf6 0%, #f3e5f5 100%); min-height: 100vh;">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-4">
        <h3 class="mb-0"><i class="fas fa-users-cog me-2" style="color:#5e35b1;"></i>Administración de usuarios</h3>
        <div class="d-flex gap-2">
            <a th:href="@{/profesor/administracion}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left me-1"></i>Volver al panel</a>
            <a th:href="@{/profesor/usuarios-sistema/crear}" class="btn btn-primary"><i class="fas fa-user-plus me-1"></i>Crear usuario</a>
        </div>
    </div>

    <!-- Tarjetas de acceso directo -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-sm-6 col-md-4">
            <a th:href="@{/profesor/pagina-publica}" class="text-decoration-none">
                <div class="card border-0 shadow-sm h-100 rounded-3 overflow-hidden" style="background: linear-gradient(135deg, #e1bee7 60%, #d1c4e9 100%); transition: transform 0.15s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform=''">
                    <div class="card-body d-flex align-items-center">
                        <i class="fas fa-globe fa-2x me-3" style="color:#5e35b1;"></i>
                        <div>
                            <div class="fw-semibold text-dark">Administración página pública</div>
                            <small class="text-muted">Planes, precios, contacto</small>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-12 col-sm-6 col-md-4">
            <div class="card border-0 shadow-sm h-100 rounded-3 overflow-hidden" style="background: linear-gradient(135deg, #ffecb3 60%, #ffe082 100%); opacity: 0.9;">
                <div class="card-body d-flex align-items-center">
                    <i class="fas fa-database fa-2x me-3" style="color:#5e35b1;"></i>
                    <div>
                        <div class="fw-semibold text-dark">Backup y resguardo</div>
                        <small class="text-muted">En desarrollo</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:if="${param.ok != null}" class="alert alert-success">Operación realizada correctamente.</div>
    <div th:if="${param.error == 'notfound'}" class="alert alert-danger">Usuario no encontrado.</div>
    <div th:if="${param.error == 'developer-locked'}" class="alert alert-warning">No está permitido modificar el usuario developer.</div>
    <div th:if="${param.error == 'no-permitido'}" class="alert alert-danger">No tenés permiso para eliminar ese usuario.</div>
    <div th:if="${param.error == 'self-rol'}" class="alert alert-warning">No podés cambiar tu propio rol a otro que no sea Admin.</div>
    <div th:if="${errorMessage != null}" class="alert alert-danger" th:text="${errorMessage}">Error</div>

    <div th:if="${correosDuplicados != null && !correosDuplicados.isEmpty()}" class="alert alert-warning alert-dismissible fade show">
        <strong><i class="fas fa-exclamation-triangle me-1"></i> Correos duplicados en la base de datos</strong>
        <p class="mb-1 mt-2 small">Revisá los correos en la tabla <code>usuario</code> o <code>profesor</code>.</p>
        <ul class="mb-0 small">
            <li th:each="msg : ${correosDuplicados}" th:text="${msg}">msg</li>
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Mi perfil -->
    <div class="card mb-4">
        <div class="card-header bg-light"><strong>Mi perfil</strong></div>
        <div class="card-body">
            <form th:action="@{/profesor/usuarios-sistema/perfil}" method="post" class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label class="form-label small">Nombre</label>
                    <input type="text" name="nombre" class="form-control form-control-sm" th:value="${usuarioActual != null ? usuarioActual.nombre : ''}" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label small">Correo</label>
                    <input type="email" name="correo" class="form-control form-control-sm" th:value="${usuarioActual != null ? usuarioActual.correo : ''}" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Rol</label>
                    <input type="text" class="form-control form-control-sm" th:value="${usuarioActual != null ? usuarioActual.rol : ''}" disabled>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-outline-primary btn-sm w-100">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Listado -->
    <div class="card">
        <div class="card-header bg-light"><strong>Listado de usuarios</strong></div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>Usuario</th>
                        <th>Correo</th>
                        <th>Rol</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="u : ${usuariosSistema}">
                        <td th:text="${u.nombre}">Nombre</td>
                        <td th:text="${u.correo}">correo@ejemplo.com</td>
                        <td>
                            <span class="badge bg-secondary" th:text="${u.rol}">ROL</span>
                        </td>
                        <td class="text-end">
                            <a th:href="@{/profesor/usuarios-sistema/editar/{id}(id=${u.id})}" class="btn btn-outline-primary btn-sm me-1" title="Modificar">
                                <i class="fas fa-edit"></i>
                            </a>
                            <th:block th:with="puedeEliminar=${usuarioActual != null && (usuarioActual.rol == 'DEVELOPER' || (usuarioActual.rol == 'ADMIN' && u.id != usuarioActual.id))}">
                                <form th:if="${puedeEliminar}" th:action="@{/profesor/usuarios-sistema/eliminar}" method="post" class="d-inline" onsubmit="return confirm('¿Eliminar a este usuario? No se puede deshacer.');">
                                    <input type="hidden" name="usuarioId" th:value="${u.id}">
                                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                                </form>
                                <span th:if="${!puedeEliminar}" class="text-muted">—</span>
                            </th:block>
                        </td>
                    </tr>
                    <tr th:if="${usuariosSistema == null || usuariosSistema.isEmpty()}">
                        <td colspan="4" class="text-center text-muted py-4">Sin usuarios del sistema.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
