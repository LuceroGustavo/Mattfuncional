<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/springsecurity">
<head>
    <meta charset="UTF-8">
    <title th:text="'Ficha de ' + ${alumno.nombre} + ' - Panel del Profesor'">Ficha del Alumno - Panel del Profesor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
     <link href="/css/footer.css" rel="stylesheet">
    <style>
        html, body {
            height: auto;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-y: auto;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            padding: 30px;
            max-width: 1400px;
            padding-bottom: 60px;
        }
        
        .hero-title {
            color: #2c3e50;
            font-weight: 700;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2rem;
        }
        
        .hero-subtitle {
            color: #7f8c8d;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        
        .btn-volver {
            background: linear-gradient(135deg, #636e72 0%, #b2bec3 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        
        .btn-volver:hover {
            background: linear-gradient(135deg, #b2bec3 0%, #636e72 100%);
            transform: translateY(-2px);
            color: white;
        }
        
        .alumno-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-left: 4px solid #667eea;
        }
        
        .info-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
            border: none;
        }
        
        .info-card .card-header {
            background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 1rem 1.5rem;
            border: none;
        }
        
        .info-card .card-header h5 {
            margin: 0;
            font-weight: 600;
        }
        
        .info-card .card-body {
            padding: 1.5rem;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #2c3e50;
            min-width: 200px;
        }
        
        .info-value {
            color: #7f8c8d;
            text-align: right;
            flex: 1;
        }
        
        .rutina-card {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(67, 233, 123, 0.2);
            transition: all 0.3s ease;
        }
        
        .rutina-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 233, 123, 0.3);
        }
        
        .rutina-card h6 {
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .rutina-card .badge {
            font-size: 0.8rem;
            padding: 0.5rem 0.75rem;
        }
        
        .btn-action {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
        }
        
        .btn-action:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-1px);
            color: white;
        }
        
        .btn-chat {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 12px 30px;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        
        .btn-chat:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-item {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
            min-height: 120px;
        }
        .stat-item:not(.stat-item-link) {
            text-align: left;
        }
        .stat-item.stat-item-link {
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .stat-item .stat-card-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        .stat-item .stat-card-content {
            font-size: 0.9rem;
            color: #5a6c7d;
            min-height: 2.8rem;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }
        .stat-item.stat-item-link {
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            transition: box-shadow 0.2s, transform 0.2s;
        }
        .stat-item.stat-item-link:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        /* Estado debajo del título: botón un poco más grande */
        .btn-estado-ficha {
            font-size: 1.05rem;
            font-weight: 600;
        }
        /* Patrón de colores igual que panel: alumnos=verde pastel, series=violeta, rutinas=amarillo, asignaciones=celeste */
        .stat-item.stat-card-alumno { background: linear-gradient(135deg, #e8f5e9 60%, #b2dfdb 100%); border-color: #a5d6a7; }
        .stat-item.stat-card-asistencia { background: linear-gradient(135deg, #e3f2fd 60%, #b3e5fc 100%); border-color: #81d4fa; }
        .stat-item.stat-card-trabajo { background: linear-gradient(135deg, #ede7f6 60%, #b39ddb 100%); border-color: #b39ddb; }
        .stat-item.stat-card-rutinas { background: linear-gradient(135deg, #fffde7 60%, #ffe082 100%); border-color: #ffd54f; }
        
        .nav-tabs .nav-link {
            border: none;
            color: #7f8c8d;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
            color: white;
            border-radius: 20px 20px 0 0;
        }
        
                 .nav-tabs .nav-link:hover {
             border: none;
             color: #667eea;
        }
        /* Historial de asistencia: mostrar 5 filas y scroll para el resto */
        .historial-asistencia-scroll {
             max-height: 220px;
             overflow-y: auto;
        }
        .historial-asistencia-scroll thead th {
             position: sticky;
             top: 0;
             background: #f8f9fa;
             z-index: 1;
             box-shadow: 0 1px 0 #dee2e6;
        }
        /* Acciones deshabilitadas cuando alumno inactivo */
        .btn-disabled-inactivo, .stat-item-link-disabled {
            pointer-events: none;
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

<!-- Navbar fragment estándar -->
<div th:replace="fragments/navbar :: navbar"></div>

<div class="container-fluid" th:with="alumnoInactivo=${alumno.estadoAlumno == 'INACTIVO'}">
    <div class="main-container">
        <div th:if="${param.progreso != null && param.progreso[0] == 'ok'}" class="alert alert-success alert-dismissible fade show" role="alert">
            Progreso guardado correctamente.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
        <!-- Header: volver, Progreso, Editar, Eliminar -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
            <a th:href="@{/profesor/{id}(id=${alumno.profesor.id})}" class="btn btn-volver">
                <i class="fas fa-arrow-left me-2"></i>Volver al Dashboard
            </a>
            <div class="d-flex flex-wrap gap-2">
                <button th:if="${!alumnoInactivo}" type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalProgreso" title="Registrar qué trabajó este alumno (grupos musculares y observaciones)">
                    <i class="fas fa-chart-line me-2"></i>Progreso
                </button>
                <button th:if="${alumnoInactivo}" type="button" class="btn btn-success btn-disabled-inactivo" disabled title="Activa el alumno para registrar progreso">
                    <i class="fas fa-chart-line me-2"></i>Progreso
                </button>
                <a th:href="@{/profesor/alumnos/editar/{id}(id=${alumno.id})}" class="btn btn-warning" title="Editar alumno">
                    <i class="fas fa-edit me-2"></i>Editar
                </a>
                <a th:href="@{/profesor/alumnos/eliminar/{id}(id=${alumno.id})}" class="btn btn-danger" title="Eliminar alumno"
                   onclick="return confirm('¿Estás seguro de que quieres eliminar este alumno?');">
                    <i class="fas fa-trash me-2"></i>Eliminar
                </a>
            </div>
        </div>
        
        <!-- Título principal y estado centrados -->
        <div class="text-center">
            <h1 class="hero-title">
                <i class="fas fa-user me-3"></i>Ficha de <span th:text="${alumno.nombre}">Nombre</span>
            </h1>
            <!-- Estado del alumno justo debajo del título, centrado -->
            <p class="mb-2">
                <span th:if="${alumno.estadoAlumno == 'ACTIVO'}" class="btn btn-success btn-estado-ficha px-4 py-2 rounded-pill shadow-sm"><i class="fas fa-check-circle me-2"></i>Activo/a</span>
                <span th:if="${alumno.estadoAlumno == 'INACTIVO'}" class="btn btn-secondary btn-estado-ficha px-4 py-2 rounded-pill shadow-sm"><i class="fas fa-pause-circle me-2"></i>Inactivo/a</span>
                <span th:if="${alumno.estadoAlumno == null}" class="btn btn-light btn-estado-ficha px-4 py-2 rounded-pill shadow-sm text-dark">-</span>
            </p>
        </div>
        <p class="hero-subtitle mb-3 text-center">Información detallada y seguimiento del progreso</p>

        <!-- Tarjetas de vista rápida (colores: alumno=verde, asistencia=celeste, trabajo=violeta, rutinas=amarillo) -->
        <div class="stats-grid">
            <!-- 1) Restricciones médicas (alumnos / salud → verde pastel) -->
            <div class="stat-item stat-card-alumno">
                <div class="stat-card-title"><i class="fas fa-heartbeat me-1"></i>Restricciones médicas</div>
                <div class="stat-card-content" th:text="${alumno.restriccionesMedicas != null && !alumno.restriccionesMedicas.isEmpty() ? alumno.restriccionesMedicas : 'Ninguna'}">Ninguna</div>
            </div>
            <!-- 2) Asistencia (horarios → celeste) -->
            <div class="stat-item stat-card-asistencia">
                <div class="stat-card-title"><i class="fas fa-calendar-alt me-1"></i>Asistencia</div>
                <div class="stat-card-content">
                    <span th:if="${#strings.toString(alumno.tipoAsistencia) == 'PRESENCIAL' || #strings.toString(alumno.tipoAsistencia) == 'SEMIPRESENCIAL'}">
                        <span th:if="${#strings.toString(alumno.tipoAsistencia) == 'PRESENCIAL'}">Presencial</span>
                        <span th:if="${#strings.toString(alumno.tipoAsistencia) == 'SEMIPRESENCIAL'}">Semipresencial</span>
                        <span th:if="${alumno.diasHorariosAsistencia != null && !alumno.diasHorariosAsistencia.isEmpty()}">
                            <br><span th:text="${#strings.listJoin(alumno.diasHorariosAsistencia.![dia], ', ')}">Lunes, Miércoles</span>
                            <span th:if="${alumno.diasHorariosAsistencia != null && !alumno.diasHorariosAsistencia.isEmpty()}" th:text="${' ' + #temporals.format(alumno.diasHorariosAsistencia[0].horaEntrada, 'HH:mm') + ' hs'}"> 18:00 hs</span>
                        </span>
                    </span>
                    <span th:if="${#strings.toString(alumno.tipoAsistencia) == 'ONLINE' || #strings.toString(alumno.tipoAsistencia) == 'VIRTUAL'}">Virtual</span>
                    <span th:if="${alumno.tipoAsistencia == null}">-</span>
                </div>
            </div>
            <!-- 3) Último trabajo (series/ejercicios → violeta) -->
            <div class="stat-item stat-card-trabajo">
                <div class="stat-card-title"><i class="fas fa-dumbbell me-1"></i>Último trabajo</div>
                <div class="stat-card-content">
                    <th:block th:if="${historialAsistencia != null && !historialAsistencia.isEmpty()}" th:with="ultima=${historialAsistencia[0]}, obs=${historialAsistencia[0].observaciones != null && !historialAsistencia[0].observaciones.isEmpty() ? (#strings.length(historialAsistencia[0].observaciones) > 60 ? #strings.substring(historialAsistencia[0].observaciones, 0, 60) + '...' : historialAsistencia[0].observaciones) : '-'}">
                        <span th:text="${#temporals.format(ultima.fecha, 'dd/MM/yyyy')}">-</span>
                        <span th:if="${ultima.gruposTrabajados != null && !ultima.gruposTrabajados.isEmpty()}" th:text="${' · ' + #strings.listJoin(ultima.gruposTrabajados, ', ')}">-</span>
                        <br>
                        <span class="text-muted small" th:title="${ultima.observaciones}" th:text="${obs}">-</span>
                    </th:block>
                    <span th:if="${historialAsistencia == null || historialAsistencia.isEmpty()}" class="text-muted">Sin registros</span>
                </div>
            </div>
            <!-- 4) Rutinas asignadas (rutinas → amarillo, clic → asignar; deshabilitado si inactivo) -->
            <a th:if="${!alumnoInactivo}" th:href="@{/profesor/asignar-rutina/{id}(id=${alumno.id})}" class="stat-item stat-item-link stat-card-rutinas text-decoration-none d-block">
                <div class="stat-number" th:text="${rutinasAsignadas != null ? rutinasAsignadas.size() : 0}">0</div>
                <div class="stat-label">Rutinas asignadas</div>
                <small class="text-muted">Clic para asignar</small>
            </a>
            <div th:if="${alumnoInactivo}" class="stat-item stat-card-rutinas stat-item-link-disabled d-block">
                <div class="stat-number" th:text="${rutinasAsignadas != null ? rutinasAsignadas.size() : 0}">0</div>
                <div class="stat-label">Rutinas asignadas</div>
                <small class="text-muted">Activa el alumno para asignar</small>
            </div>
        </div>

        <!-- Datos personales del alumno (una sola tarjeta) -->
        <div class="alumno-info">
            <div class="row align-items-start">
                <div class="col-lg-3 col-md-4 mb-3 mb-md-0">
                    <h4 class="mb-3">
                        <i class="fas fa-user me-2"></i>
                        <span th:text="${alumno.nombre}">Nombre del Alumno</span>
                    </h4>
                    <p class="mb-1"><strong>Edad:</strong> <span th:text="${alumno.edad}">Edad</span> años</p>
                    <p class="mb-1"><strong>Sexo:</strong> <span th:text="${alumno.sexo}">Sexo</span></p>
                    <p class="mb-1"><strong>Email:</strong> <span th:text="${alumno.correo}">Email</span></p>
                    <p class="mb-0"><strong>Celular:</strong> <span th:text="${alumno.celular != null ? alumno.celular : '-'}">-</span></p>
                </div>
                <div class="col-lg-3 col-md-4 mb-3 mb-md-0">
                    <p class="mb-1"><strong>Fecha de Inicio:</strong> <span th:text="${alumno.fechaInicio != null ? #temporals.format(alumno.fechaInicio, 'dd/MM/yyyy') : '-'}">-</span></p>
                    <p class="mb-0"><strong>Contacto de Emergencia:</strong> <span th:text="${alumno.contactoEmergenciaNombre != null ? alumno.contactoEmergenciaNombre + ' (' + alumno.contactoEmergenciaTelefono + ')' : '-'}">-</span></p>
                </div>
                <div class="col-lg-3 col-md-4 mb-3 mb-md-0">
                    <p class="mb-1"><strong>Restricciones Médicas:</strong> <span th:text="${alumno.restriccionesMedicas != null && !alumno.restriccionesMedicas.isEmpty() ? alumno.restriccionesMedicas : '-'}">-</span></p>
                    <p class="mb-1"><strong>Historial de Estado:</strong></p>
                    <p class="mb-1 small" th:text="${historialEstadoFormateado != null && !historialEstadoFormateado.isEmpty() ? historialEstadoFormateado : (alumno.historialEstado != null ? alumno.historialEstado : '-')}">-</p>
                    <p class="mb-0"><strong>Objetivos:</strong> <span class="small" th:text="${alumno.objetivosPersonales != null && !alumno.objetivosPersonales.isEmpty() ? alumno.objetivosPersonales : '-'}">-</span></p>
                </div>
            </div>
        </div>

        <!-- Historial de Asistencia -->
        <div class="info-card">
            <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
                <h5 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Historial de Asistencia</h5>
                <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalResumenAsistencias">
                    Consultar asistencias
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive historial-asistencia-scroll">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Fecha</th>
                                <th>Estado</th>
                                <th>Trabajado ese día</th>
                                <th>Profesor</th>
                                <th>Observaciones</th>
                            </tr>
                        </thead>
                        <tbody id="historialAsistenciaBody">
                            <tr th:each="asistencia : ${historialAsistencia}"
                                th:attr="data-fecha=${#temporals.format(asistencia.fecha, 'yyyy-MM-dd')}, data-presente=${asistencia.presente}">
                                <td th:text="${#temporals.format(asistencia.fecha, 'dd/MM/yyyy')}">Fecha</td>
                                <td>
                                    <span th:if="${asistencia.pendiente}" class="badge bg-secondary">Pendiente</span>
                                    <span th:if="${!asistencia.pendiente and asistencia.presente == true}" class="badge bg-success">Presente</span>
                                    <span th:if="${!asistencia.pendiente and asistencia.presente == false}" class="badge bg-danger">Ausente</span>
                                </td>
                                <td>
                                    <span th:if="${asistencia.gruposTrabajados != null && !asistencia.gruposTrabajados.isEmpty()}" th:text="${#strings.listJoin(asistencia.gruposTrabajados, ', ')}">-</span>
                                    <span th:if="${asistencia.gruposTrabajados == null || asistencia.gruposTrabajados.isEmpty()}" class="text-muted">-</span>
                                </td>
                                <td>
                                    <span th:if="${(asistencia.gruposTrabajados != null && !asistencia.gruposTrabajados.isEmpty()) || (asistencia.observaciones != null && !asistencia.observaciones.isEmpty()) and !(#authentication.principal != null and #authentication.principal.rol == 'ADMIN')}"
                                          class="profesor-display"
                                          th:text="${asistencia.registradoPorNombre != null ? asistencia.registradoPorNombre : ''}"></span>
                                    <select th:if="${#authentication.principal != null and #authentication.principal.rol == 'ADMIN' and ((asistencia.gruposTrabajados != null && !asistencia.gruposTrabajados.isEmpty()) || (asistencia.observaciones != null && !asistencia.observaciones.isEmpty()))}"
                                            class="form-select form-select-sm w-auto profesor-select"
                                            th:attr="data-asistencia-id=${asistencia.id}">
                                        <option th:each="u : ${usuariosSistema}" th:value="${u.id}"
                                                th:selected="${asistencia.registradoPorId != null ? u.id == asistencia.registradoPorId : (#authentication.principal != null ? #authentication.principal.id == u.id : false)}"
                                                th:text="${u.nombre}">Profesor</option>
                                    </select>
                                </td>
                                <td th:text="${asistencia.observaciones != null && !asistencia.observaciones.isEmpty() ? asistencia.observaciones : '-'}">-</td>
                            </tr>
                            <tr th:if="${historialAsistencia == null || historialAsistencia.isEmpty()}">
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="fas fa-calendar-times fa-2x mb-2"></i>
                                    <p class="mb-0">Sin registros de asistencia. Usa el botón <strong>Progreso</strong> para cargar.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Modal: resumen mensual de asistencias -->
        <div class="modal fade" id="modalResumenAsistencias" tabindex="-1" aria-labelledby="modalResumenAsistenciasLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalResumenAsistenciasLabel">
                            <i class="fas fa-calendar-alt me-2"></i>Resumen mensual de asistencias
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                            <label for="resumenMesSelect" class="form-label mb-0">Mes</label>
                            <select id="resumenMesSelect" class="form-select form-select-sm w-auto">
                                <option value="">Seleccionar mes</option>
                            </select>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Mes</th>
                                        <th>Asistencias</th>
                                        <th>Ausencias</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody id="resumenAsistenciasBody">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-3">Sin datos de asistencia.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <hr class="my-3">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="detalleAsistenciasBody">
                                    <tr>
                                        <td colspan="2" class="text-center text-muted py-3">Selecciona un mes para ver el detalle.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Progreso: registrar grupos trabajados y observaciones -->
        <div class="modal fade" id="modalProgreso" tabindex="-1" aria-labelledby="modalProgresoLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                        <h5 class="modal-title" id="modalProgresoLabel"><i class="fas fa-chart-line me-2"></i>Registrar progreso</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <form th:action="@{/profesor/alumnos/{id}/progreso(id=${alumno.id})}" method="post">
                        <div class="modal-body">
                            <p class="text-muted small">Indica la fecha, si estuvo presente, qué grupos musculares trabajó y observaciones. Si ya existe registro para esa fecha, se actualizará.</p>
                            <div class="mb-3">
                                <label for="progresoFecha" class="form-label">Fecha</label>
                                <input type="date" id="progresoFecha" name="fecha" class="form-control" th:value="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}" required>
                            </div>
                            <div class="mb-3" th:if="${gruposMusculares != null && !gruposMusculares.isEmpty()}">
                                <label class="form-label">Grupos musculares trabajados</label>
                                <div class="border rounded p-2" style="max-height: 180px; overflow-y: auto;">
                                    <div class="row g-1" th:each="g : ${gruposMusculares}">
                                        <div class="col-12 col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="grupoIds" th:value="${g.id}" th:id="${'grupo-' + g.id}"
                                                       th:checked="${asistenciaHoy != null && asistenciaHoy.gruposTrabajados != null && #lists.contains(asistenciaHoy.gruposTrabajados.![id], g.id)}">
                                                <label class="form-check-label" th:for="${'grupo-' + g.id}" th:text="${g.nombre}">Grupo</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-text">Puedes marcar varios (el alumno pudo trabajar distintos grupos ese día). En el historial se mostrarán separados por coma.</div>
                            </div>
                            <div class="mb-3">
                                <label for="progresoObservaciones" class="form-label">Observaciones</label>
                                <textarea id="progresoObservaciones" name="observaciones" class="form-control" rows="3" maxlength="2000" placeholder="Ej: Buen ritmo, trabajó bien piernas..."
                                          th:text="${asistenciaHoy != null && asistenciaHoy.observaciones != null ? asistenciaHoy.observaciones : ''}"></textarea>
                                <div class="form-text">Máximo 2000 caracteres.</div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-success"><i class="fas fa-save me-1"></i>Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Rutinas del Alumno -->
        <div class="info-card">
            <div class="card-header">
                <h5><i class="fas fa-dumbbell me-2"></i>Rutinas del Alumno</h5>
    </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <span class="text-muted">Historial de rutinas asignadas</span>
                    <a th:if="${!alumnoInactivo}" th:href="@{/profesor/asignar-rutina/{id}(id=${alumno.id})}" class="btn btn-success btn-sm">
                        <i class="fas fa-dumbbell me-1"></i>Asignar rutina
                    </a>
                    <span th:if="${alumnoInactivo}" class="btn btn-success btn-sm btn-disabled-inactivo disabled">Asignar rutina (activa al alumno)</span>
                </div>

                <div th:if="${rutinasAsignadas == null || rutinasAsignadas.isEmpty()}" class="text-center text-muted py-5">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <h6>Sin rutinas asignadas</h6>
                    <p class="text-muted">Todavía no hay rutinas asignadas a este alumno.</p>
                </div>
                <div th:if="${rutinasAsignadas != null && !rutinasAsignadas.isEmpty()}" class="table-responsive">
                    <table class="table table-sm table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Fecha</th>
                                <th>Rutina</th>
                                <th>Categoría</th>
                                <th>Series</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="rutina : ${rutinasAsignadas}">
                                <td th:text="${rutina.fechaCreacion != null ? #temporals.format(rutina.fechaCreacion, 'dd/MM/yyyy') : 'Sin fecha'}">Fecha</td>
                                <td th:text="${rutina.nombre}">Nombre</td>
                                <td>
                                    <span class="badge bg-secondary" th:text="${rutina.categoria != null ? rutina.categoria : 'N/A'}">Categoría</span>
                                </td>
                                <td>
                                    <span class="badge bg-info" th:text="${rutina.series != null ? rutina.series.size() : 0}">0</span>
                                </td>
                                <td class="d-flex gap-2">
                                    <a th:if="${!alumnoInactivo}" th:href="@{/rutinas/ver/{id}(id=${rutina.id})}" class="btn btn-info btn-sm" target="_blank" rel="noopener">
                                        <i class="fas fa-eye me-1"></i>Ver
                                    </a>
                                    <span th:if="${alumnoInactivo}" class="btn btn-info btn-sm btn-disabled-inactivo disabled"><i class="fas fa-eye me-1"></i>Ver</span>
                                    <button th:if="${!alumnoInactivo}" type="button"
                                            class="btn btn-outline-dark btn-sm copiar-enlace-rutina"
                                            th:attr="data-url=@{/rutinas/hoja/{token}(token=${rutina.tokenPublico})}">
                                        <i class="fas fa-link me-1"></i>Copiar enlace
                                    </button>
                                    <button th:if="${alumnoInactivo}" type="button" class="btn btn-outline-dark btn-sm btn-disabled-inactivo disabled">
                                        <i class="fas fa-link me-1"></i>Copiar enlace
                                    </button>
                                    <a th:if="${!alumnoInactivo}" href="#" class="btn btn-success btn-sm compartir-whatsapp" target="_blank" rel="noopener"
                                       th:attr="data-url=@{/rutinas/hoja/{token}(token=${rutina.tokenPublico})},data-phone=${alumno.celular}">
                                        <i class="fab fa-whatsapp me-1"></i>WhatsApp
                                    </a>
                                    <span th:if="${alumnoInactivo}" class="btn btn-success btn-sm btn-disabled-inactivo disabled"><i class="fab fa-whatsapp me-1"></i>WhatsApp</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Notas Privadas del Profesor -->
        <div class="info-card">
            <div class="card-header">
                <h5><i class="fas fa-sticky-note me-2"></i>Notas Privadas del Profesor</h5>
            </div>
            <div class="card-body">
                <textarea class="form-control" rows="3" placeholder="Escribe notas privadas sobre el alumno... Solo visible para el profesor."></textarea>
    </div>
    </div>
     </div>
</div>
 
 <!-- Footer Fragment -->
 <div th:replace="fragments/footer :: footer"></div>
 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        var isAdminUsuario = /*[[${#authentication.principal != null and #authentication.principal.rol == 'ADMIN'}]]*/ false;
        var currentUserId = /*[[${#authentication.principal != null ? #authentication.principal.id : 0}]]*/ 0;
        var currentUserName = '[[${#authentication.principal != null ? #authentication.principal.nombre : ''}]]';
        var usuariosSistema = [
            /*[# th:each="u,stat : ${usuariosSistema}"]*/
            { id: [[${u.id}]], nombre: '[[${u.nombre}]]' }/*[[${stat.last} ? '' : ',' ]]*/
            /*[/]*/
        ];
    </script>
    <script>
        document.querySelectorAll('.copiar-enlace-rutina').forEach(btn => {
            btn.addEventListener('click', async () => {
                const relativeUrl = btn.getAttribute('data-url') || '';
                const fullUrl = new URL(relativeUrl, window.location.origin).toString();
                try {
                    await navigator.clipboard.writeText(fullUrl);
                    alert('Enlace copiado.');
                } catch (error) {
                    const tempInput = document.createElement('input');
                    tempInput.value = fullUrl;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    tempInput.remove();
                    alert('Enlace copiado.');
                }
            });
        });

        document.querySelectorAll('.compartir-whatsapp').forEach(link => {
            const relativeUrl = link.getAttribute('data-url') || '';
            const fullUrl = new URL(relativeUrl, window.location.origin).toString();
            const mensaje = encodeURIComponent('Rutina: ' + fullUrl);
            const rawPhone = link.getAttribute('data-phone') || '';
            const phone = rawPhone.replace(/[^\d]/g, '');
            link.href = phone ? `https://wa.me/${phone}?text=${mensaje}` : `https://wa.me/?text=${mensaje}`;
        });

        // Si se llegó con openModal=progreso (p. ej. desde el botón Progreso del dashboard), abrir el modal al cargar
        (function() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('openModal') === 'progreso') {
                const modalEl = document.getElementById('modalProgreso');
                if (modalEl && typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                }
            }
        })();

        // Al cargar la ficha, refrescar el historial de asistencia desde el servidor para que coincida con el calendario
        (function() {
            var historialBody = document.getElementById('historialAsistenciaBody');
            if (!historialBody) return;
            var m = window.location.pathname.match(/\/profesor\/alumnos\/(\d+)/);
            var alumnoId = m ? m[1] : null;
            if (!alumnoId) return;
            function renderProfesorCell(asistenciaId, registradoPorId, registradoPorNombre, gruposTrabajados, observaciones) {
                var tieneTrabajo = (gruposTrabajados && gruposTrabajados.length) || (observaciones && observaciones.trim());
                if (!tieneTrabajo) return '';
                var displayName = registradoPorNombre || '';
                if (!isAdminUsuario) {
                    return '<span class="profesor-display">' + displayName + '</span>';
                }
                var selectedId = registradoPorId || '';
                var options = (usuariosSistema || []).map(function(u) {
                    var selected = (selectedId && u.id === selectedId) ? ' selected' : '';
                    return '<option value="' + u.id + '"' + selected + '>' + u.nombre + '</option>';
                }).join('');
                return '<select class="form-select form-select-sm w-auto profesor-select" data-asistencia-id="' + asistenciaId + '">' + options + '</select>';
            }
            fetch('/profesor/alumnos/' + alumnoId + '/asistencias', { headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' } })
                .then(function(res) { return res.ok ? res.json() : null; })
                .then(function(data) {
                    if (data === null) return;
                    if (!data || data.length === 0) {
                        historialBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4"><i class="fas fa-calendar-times fa-2x mb-2"></i><p class="mb-0">Sin registros de asistencia. Usa el botón <strong>Progreso</strong> o marca desde el calendario.</p></td></tr>';
                        return;
                    }
                    var rowsHtml = '';
                    data.sort(function(a, b) { return (b.fecha || '').localeCompare(a.fecha || ''); });
                    data.forEach(function(r) {
                        var grupos = (r.gruposTrabajados && r.gruposTrabajados.length) ? r.gruposTrabajados.join(', ') : '-';
                        var obs = (r.observaciones && r.observaciones.trim()) ? r.observaciones : '-';
                        var profesorCell = renderProfesorCell(r.id, r.registradoPorId, r.registradoPorNombre, r.gruposTrabajados, r.observaciones);
                        var estadoHtml = r.pendiente ? '<span class="badge bg-secondary">Pendiente</span>'
                            : (r.presente ? '<span class="badge bg-success">Presente</span>' : '<span class="badge bg-danger">Ausente</span>');
                        rowsHtml += '<tr data-fecha="' + (r.fecha || '') + '" data-presente="' + (r.presente === true ? 'true' : 'false') + '">' +
                            '<td>' + (r.fechaFormateada || r.fecha) + '</td>' +
                            '<td>' + estadoHtml + '</td>' +
                            '<td class="text-muted">' + grupos + '</td>' +
                            '<td>' + profesorCell + '</td>' +
                            '<td>' + obs + '</td>' +
                            '</tr>';
                    });
                    historialBody.innerHTML = rowsHtml;
                })
                .catch(function() {});
        })();

        // Resumen mensual de asistencias: al abrir el modal se cargan asistencias actualizadas del servidor
        // (incluye marcas hechas desde el calendario, p. ej. presente por excepción) y se actualiza también el historial.
        (function() {
            const modalEl = document.getElementById('modalResumenAsistencias');
            const tbodyResumen = document.getElementById('resumenAsistenciasBody');
            const detalleBody = document.getElementById('detalleAsistenciasBody');
            const mesSelect = document.getElementById('resumenMesSelect');
            const historialBody = document.getElementById('historialAsistenciaBody');
            if (!modalEl || !tbodyResumen) return;
            const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            function getAlumnoId() {
                var m = window.location.pathname.match(/\/profesor\/alumnos\/(\d+)/);
                return m ? m[1] : null;
            }
            function construirDetalle(registros, clave) {
                if (!detalleBody) return;
                detalleBody.innerHTML = '';
                if (!clave) {
                    detalleBody.innerHTML = '<tr><td colspan="2" class="text-center text-muted py-3">Selecciona un mes para ver el detalle.</td></tr>';
                    return;
                }
                var items = registros.filter(function(r) { return r.claveMes === clave && !r.pendiente; });
                if (items.length === 0) {
                    detalleBody.innerHTML = '<tr><td colspan="2" class="text-center text-muted py-3">Sin registros en este mes.</td></tr>';
                    return;
                }
                items.sort(function(a, b) { return b.fecha.localeCompare(a.fecha); });
                items.forEach(function(item) {
                    var tr = document.createElement('tr');
                    tr.innerHTML = '<td>' + item.fechaFormateada + '</td>' +
                        '<td>' + (item.presente
                            ? '<span class="badge bg-success">Presente</span>'
                            : '<span class="badge bg-danger">Ausente</span>') + '</td>';
                    detalleBody.appendChild(tr);
                });
            }
            function renderProfesorCell(asistenciaId, registradoPorId, registradoPorNombre, gruposTrabajados, observaciones) {
                var tieneTrabajo = (gruposTrabajados && gruposTrabajados.length) || (observaciones && observaciones.trim());
                if (!tieneTrabajo) return '';
                var displayName = registradoPorNombre || '';
                if (!isAdminUsuario) {
                    return '<span class="profesor-display">' + displayName + '</span>';
                }
                var selectedId = registradoPorId || '';
                var options = (usuariosSistema || []).map(function(u) {
                    var selected = (selectedId && u.id === selectedId) ? ' selected' : '';
                    return '<option value="' + u.id + '"' + selected + '>' + u.nombre + '</option>';
                }).join('');
                return '<span class="profesor-display profesor-editable" data-asistencia-id="' + asistenciaId + '" data-registrado-id="' + selectedId + '">' + displayName + '</span>' +
                    '<select class="form-select form-select-sm w-auto profesor-select d-none" data-asistencia-id="' + asistenciaId + '">' + options + '</select>';
            }
            function actualizarHistorialYModal(registros) {
                            var resumen = new Map();
                            registros.forEach(function(r) {
                                if (!r.fecha || r.pendiente) return;
                    var partes = r.fecha.split('-');
                    if (partes.length < 2) return;
                    var clave = partes[0] + '-' + partes[1];
                    if (!resumen.has(clave)) resumen.set(clave, { presente: 0, ausente: 0 });
                    var item = resumen.get(clave);
                    if (r.presente) item.presente += 1; else item.ausente += 1;
                });
                // No actualizar el historial al abrir el modal para evitar perder la vista del progreso.
                if (resumen.size === 0) {
                    tbodyResumen.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">Sin datos de asistencia.</td></tr>';
                    if (mesSelect) { mesSelect.innerHTML = '<option value="">Seleccionar mes</option>'; }
                    construirDetalle([], '');
                    return;
                }
                var clavesOrdenadas = Array.from(resumen.keys()).sort();
                tbodyResumen.innerHTML = '';
                clavesOrdenadas.forEach(function(clave) {
                    var item = resumen.get(clave);
                    var partes = clave.split('-');
                    var monthIdx = Math.max(0, Math.min(11, parseInt(partes[1], 10) - 1));
                    var mesLabel = meses[monthIdx] + ' ' + partes[0];
                    var total = item.presente + item.ausente;
                    var tr = document.createElement('tr');
                    tr.innerHTML = '<td>' + mesLabel + '</td><td><span class="badge bg-success">' + item.presente + '</span></td><td><span class="badge bg-secondary">' + item.ausente + '</span></td><td>' + total + '</td>';
                    tbodyResumen.appendChild(tr);
                });
                if (mesSelect) {
                    mesSelect.innerHTML = '<option value="">Seleccionar mes</option>';
                    clavesOrdenadas.forEach(function(clave) {
                        var partes = clave.split('-');
                        var monthIdx = Math.max(0, Math.min(11, parseInt(partes[1], 10) - 1));
                        var opt = document.createElement('option');
                        opt.value = clave;
                        opt.textContent = meses[monthIdx] + ' ' + partes[0];
                        mesSelect.appendChild(opt);
                    });
                    var ultimoMes = clavesOrdenadas[clavesOrdenadas.length - 1];
                    mesSelect.value = ultimoMes;
                    mesSelect.onchange = function() { construirDetalle(registros, mesSelect.value); };
                    construirDetalle(registros, ultimoMes);
                } else {
                    construirDetalle(registros, '');
                }
            }
            function obtenerRegistrosDesdeTabla() {
                if (!historialBody) return [];
                var rows = Array.from(historialBody.querySelectorAll('tr[data-fecha]'));
                if (!rows.length) return [];
                return rows.map(function(row) {
                    var fecha = row.getAttribute('data-fecha') || '';
                    var fechaFormateada = '';
                    var fechaCell = row.querySelector('td');
                    if (fechaCell) fechaFormateada = fechaCell.textContent.trim();
                    var estadoCell = row.querySelectorAll('td')[1];
                    var estadoTexto = estadoCell ? estadoCell.textContent.trim().toLowerCase() : '';
                    var esPendiente = estadoTexto.indexOf('pendiente') !== -1 || estadoTexto.indexOf('sin registro') !== -1;
                    var esPresente = estadoTexto.indexOf('presente') !== -1;
                    return {
                        fecha: fecha,
                        fechaFormateada: fechaFormateada || fecha,
                        presente: esPendiente ? null : esPresente,
                        pendiente: esPendiente,
                        claveMes: (fecha && fecha.indexOf('-') !== -1) ? fecha.split('-').slice(0, 2).join('-') : '',
                        id: null,
                        gruposTrabajados: [],
                        observaciones: '',
                        registradoPorId: null,
                        registradoPorNombre: ''
                    };
                });
            }

            function normalizarRegistros(data) {
                if (!Array.isArray(data)) return null;
                return data.map(function(a) {
                    var fecha = a.fecha || '';
                    var partes = fecha.split('-');
                    var clave = partes.length >= 2 ? partes[0] + '-' + partes[1] : '';
                    var presenteVal = (a.presente === true) ? true : (a.presente === false ? false : null);
                    return {
                        fecha: fecha,
                        fechaFormateada: a.fechaFormateada || fecha,
                        presente: presenteVal,
                        pendiente: !!a.pendiente,
                        claveMes: clave,
                        id: a.id,
                        gruposTrabajados: a.gruposTrabajados || [],
                        observaciones: a.observaciones || '',
                        registradoPorId: a.registradoPorId || null,
                        registradoPorNombre: a.registradoPorNombre || ''
                    };
                });
            }

            modalEl.addEventListener('show.bs.modal', function() {
                var alumnoId = getAlumnoId();
                if (!alumnoId) {
                    actualizarHistorialYModal([]);
                    return;
                }
                var url = '/profesor/alumnos/' + alumnoId + '/asistencias';
                fetch(url, { headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' } })
                    .then(function(res) { return res.ok ? res.json() : null; })
                    .then(function(data) {
                        if (data === null) {
                            var fallbackNull = obtenerRegistrosDesdeTabla();
                            actualizarHistorialYModal(fallbackNull);
                            return;
                        }
                        var registros = normalizarRegistros(data) || [];
                        if (!registros.length) {
                            registros = obtenerRegistrosDesdeTabla();
                        }
                        registros.sort(function(a, b) { return (b.fecha || '').localeCompare(a.fecha || ''); });
                        actualizarHistorialYModal(registros);
                    })
                    .catch(function() {
                        var fallback = obtenerRegistrosDesdeTabla();
                        actualizarHistorialYModal(fallback);
                    });
            });
        })();

        // Admin: selector visible y guardado automático
        (function() {
            if (!isAdminUsuario) return;
            document.addEventListener('change', function(e) {
                var select = e.target;
                if (!select.classList || !select.classList.contains('profesor-select')) return;
                var asistenciaId = select.getAttribute('data-asistencia-id');
                var registradoPorId = select.value;
                var m = window.location.pathname.match(/\/profesor\/alumnos\/(\d+)/);
                var alumnoId = m ? m[1] : null;
                if (!asistenciaId || !registradoPorId || !alumnoId) return;
                fetch('/profesor/alumnos/' + alumnoId + '/asistencias/' + asistenciaId + '/registrado-por', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'XMLHttpRequest' },
                    body: 'registradoPorId=' + encodeURIComponent(registradoPorId)
                }).catch(function() {});
            });
        })();
    </script>
 
</body>
</html> 